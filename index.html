<!DOCTYPE html>
<html lang="en" class="h-full">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Periscope</title>
    <link rel="icon" href="Periscope.webp" />
    <script>
        (function () {
            try {
                var localTheme = localStorage.getItem('theme');
                var supportDarkMode = window.matchMedia('(prefers-color-scheme: dark)').matches;
                if (localTheme === 'dark' || (!localTheme && supportDarkMode)) document.documentElement.classList.add('dark');
            } catch (e) { }
        })();
    </script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism-tomorrow.min.css" rel="stylesheet" />
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    fontFamily: { sans: ['Inter', 'sans-serif'], mono: ['JetBrains Mono', 'monospace'] },
                    colors: { slate: { 850: '#1e293b', 900: '#0f172a', 950: '#020617' }, cyan: { 400: '#22d3ee', 500: '#06b6d4', 900: '#164e63' } },
                    animation: { 'radar': 'radar 2s cubic-bezier(0, 0, 0.2, 1) infinite', 'scale-in': 'scaleIn 0.1s ease-out' },
                    keyframes: { radar: { '75%, 100%': { transform: 'scale(2)', opacity: '0' } }, scaleIn: { '0%': { transform: 'scale(0.95)', opacity: '0' }, '100%': { transform: 'scale(1)', opacity: '1' } } }
                }
            }
        }
    </script>
    <link href="https://cdn.jsdelivr.net/npm/@mdi/font@7.4.47/css/materialdesignicons.min.css" rel="stylesheet">
    <style>
        [v-cloak] {
            display: none;
        }

        .custom-scroll::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }

        .custom-scroll::-webkit-scrollbar-track {
            background: transparent;
        }

        .custom-scroll::-webkit-scrollbar-thumb {
            background-color: rgba(6, 182, 212, 0.2);
            border-radius: 4px;
        }

        .custom-scroll::-webkit-scrollbar-thumb:hover {
            background-color: rgba(6, 182, 212, 0.5);
        }
    </style>
</head>

<body
    class="h-full bg-slate-50 text-slate-800 dark:bg-slate-950 dark:text-slate-200 transition-colors duration-200 selection:bg-cyan-500/30">

    <div id="app" v-cloak class="min-h-full flex flex-col" @click="contextMenu.show = false">

        <nav
            class="sticky top-0 z-40 w-full backdrop-blur-lg bg-white/70 dark:bg-slate-950/70 border-b border-slate-200 dark:border-slate-800/50">
            <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
                <div class="flex items-center justify-between h-16">
                    <div @click="resetView()" class="flex items-center gap-3 cursor-pointer group select-none">
                        <div class="relative">
                            <img src="Periscope.webp" alt="Logo"
                                class="h-8 w-8 object-contain relative z-10 transition-transform group-hover:rotate-12">
                            <div
                                class="absolute inset-0 rounded-full bg-cyan-400 opacity-0 group-hover:animate-radar z-0">
                            </div>
                        </div>
                        <span
                            class="font-bold text-lg tracking-tight text-slate-900 dark:text-cyan-50 group-hover:text-cyan-600 dark:group-hover:text-cyan-400 transition-colors">Periscope</span>
                        <span v-if="localMode"
                            class="bg-cyan-100 dark:bg-cyan-900/30 text-cyan-800 dark:text-cyan-300 text-[10px] uppercase tracking-wider px-2 py-0.5 rounded-full font-bold border border-cyan-200 dark:border-cyan-800/50">Local
                            Bridge</span>
                    </div>
                    <div class="flex items-center gap-2">
                        <a href="https://github.com/austinginder/periscope" target="_blank"
                            class="h-10 w-10 flex items-center justify-center rounded-full hover:bg-slate-200 dark:hover:bg-slate-800 text-slate-500 dark:text-slate-400 hover:text-cyan-600 dark:hover:text-cyan-400 transition-colors">
                            <span class="mdi mdi-github text-xl"></span>
                        </a>
                    
                        <button @click="openHistory()"
                            class="h-10 w-10 flex items-center justify-center rounded-full hover:bg-slate-200 dark:hover:bg-slate-800 text-slate-500 dark:text-slate-400 hover:text-cyan-600 dark:hover:text-cyan-400 transition-colors">
                            <span class="mdi mdi-history text-xl"></span>
                        </button>

                        <button @click="showHelpModal = true"
                            class="h-10 w-10 flex items-center justify-center rounded-full hover:bg-slate-200 dark:hover:bg-slate-800 text-slate-500 dark:text-slate-400 hover:text-cyan-600 dark:hover:text-cyan-400 transition-colors">
                            <span class="mdi mdi-help-circle-outline text-xl"></span>
                        </button>

                        <button @click="toggleTheme()"
                            class="h-10 w-10 flex items-center justify-center rounded-full hover:bg-slate-200 dark:hover:bg-slate-800 text-slate-500 dark:text-slate-400 hover:text-cyan-600 dark:hover:text-cyan-400 transition-colors">
                            <span class="mdi text-xl"
                                :class="currentTheme === 'dark' ? 'mdi-white-balance-sunny' : 'mdi-moon-waning-crescent'">
                            </span>
                        </button>
                    </div>
                </div>
            </div>
        </nav>

        <main class="flex-grow w-full max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">

            <div class="max-w-3xl mx-auto mb-10 transition-all duration-500 relative z-30"
                :class="{'mt-10 md:mt-20 scale-110': !response.domain, 'mt-0': response.domain}">
                <div class="relative group">
                    <div
                        class="absolute -inset-1 bg-gradient-to-r from-cyan-500 to-sky-600 rounded-lg blur opacity-25 group-hover:opacity-50 transition duration-1000 group-hover:duration-200">
                    </div>
                    <div
                        class="relative flex items-center bg-white dark:bg-slate-900 rounded-lg ring-1 ring-slate-900/5 dark:ring-white/10 shadow-xl">
                        <div class="pl-4 text-slate-400"><span class="mdi mdi-radar text-2xl"></span></div>
                        <input v-model="domain" @keydown.enter="lookupDomain()" @input="showAutocomplete = true"
                            @focus="showAutocomplete = true" @blur="handleBlur" type="text"
                            class="w-full bg-transparent border-0 py-4 px-4 text-slate-900 dark:text-white placeholder-slate-400 focus:ring-0 focus:outline-none sm:text-lg"
                            placeholder="Target domain (e.g., google.com)" spellcheck="false" autocomplete="off"
                            autofocus>
                        <div class="pr-2">
                            <button @click="lookupDomain()"
                                class="inline-flex items-center px-4 py-2 border border-transparent text-sm font-medium rounded-md shadow-sm text-white bg-cyan-600 hover:bg-cyan-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-cyan-500 disabled:opacity-50 disabled:cursor-not-allowed transition-all"
                                :disabled="loading">
                                <svg v-if="loading" class="animate-spin -ml-1 mr-2 h-4 w-4 text-white"
                                    xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                                    <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor"
                                        stroke-width="4"></circle>
                                    <path class="opacity-75" fill="currentColor"
                                        d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z">
                                    </path>
                                </svg>
                                {{ loading ? loadingText : 'Scan' }}
                            </button>
                        </div>
                    </div>
                    <div v-if="showAutocomplete && filteredHistory.length > 0"
                        class="absolute top-full left-0 right-0 mt-2 bg-white dark:bg-slate-900 rounded-lg border border-slate-200 dark:border-slate-800 shadow-2xl overflow-hidden max-h-60 overflow-y-auto custom-scroll z-50">
                        <div
                            class="px-3 py-2 text-xs font-semibold text-slate-500 uppercase tracking-wider bg-slate-50 dark:bg-slate-950/50">
                            History Suggestions</div>
                        <ul>
                            <li v-for="item in filteredHistory" :key="item.domain" @mousedown="selectAutocomplete(item)"
                                class="px-4 py-3 hover:bg-cyan-50 dark:hover:bg-cyan-900/20 cursor-pointer transition-colors border-b border-slate-100 dark:border-slate-800/50 last:border-0 group">
                                <div class="flex items-center justify-between">
                                    <span
                                        class="text-slate-700 dark:text-slate-200 font-medium group-hover:text-cyan-700 dark:group-hover:text-cyan-400">{{
                                        item.domain }}</span>
                                    <span class="text-xs text-slate-400 font-mono">{{ new Date(item.timestamp *
                                        1000).toLocaleDateString() }}</span>
                                </div>
                            </li>
                        </ul>
                    </div>
                </div>
                <!-- Progress Bar -->
                <div v-if="loading && !loadingFromHistory" class="mt-4 animate-fade-in-up">
                    <div class="flex justify-between text-xs text-slate-500 dark:text-slate-400 mb-1">
                        <span>{{ progress.message }}</span>
                        <span>{{ progress.step }}/{{ progress.total }}</span>
                    </div>
                    <div class="w-full bg-slate-200 dark:bg-slate-700 rounded-full h-2 overflow-hidden">
                        <div class="bg-gradient-to-r from-cyan-500 to-sky-500 h-2 rounded-full transition-all duration-300 ease-out"
                             :style="{ width: progress.percent + '%' }"></div>
                    </div>
                </div>
                <!-- History Loading -->
                <div v-if="loading && loadingFromHistory" class="mt-4 animate-fade-in-up">
                    <div class="flex items-center justify-center gap-2 text-sm text-slate-500 dark:text-slate-400">
                        <span class="mdi mdi-refresh animate-spin"></span>
                        <span>Refreshing scan data...</span>
                    </div>
                </div>
                <div v-if="response.errors.length > 0" class="mt-4 space-y-2 animate-fade-in-up">
                    <div v-for="error in response.errors"
                        class="bg-red-50 dark:bg-red-900/20 border-l-4 border-red-500 p-4 rounded-md shadow-sm">
                        <div class="flex">
                            <div class="flex-shrink-0"><span class="mdi mdi-alert-circle text-red-500"></span></div>
                            <div class="ml-3">
                                <p class="text-sm text-red-700 dark:text-red-200" v-html="error"></p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div v-if="!localMode && !response.domain" class="max-w-2xl mx-auto mt-16 text-center animate-fade-in-up">
                <h2 class="text-2xl font-bold text-slate-900 dark:text-white mb-4">Run searches locally</h2>
                <p class="text-slate-600 dark:text-slate-400 mb-8">Periscope connects to your local terminal to run
                    `dig` and `whois` commands securely.</p>
                <div class="relative group text-left mx-auto max-w-xl">
                    <div
                        class="absolute -inset-0.5 bg-gradient-to-r from-cyan-500 to-blue-500 rounded-lg blur opacity-30 group-hover:opacity-60 transition duration-1000 group-hover:duration-200">
                    </div>
                    <div
                        class="relative bg-slate-900 rounded-lg p-4 shadow-2xl border border-slate-800 flex items-center justify-between overflow-hidden">
                        <div class="overflow-x-auto custom-scroll mr-2"><code
                                class="font-mono text-cyan-400 text-sm sm:text-base whitespace-nowrap">curl -sL https://periscope.run/boot.sh | bash</code>
                        </div>
                        <button @click="copyInstallCmd"
                            class="p-2 text-slate-500 hover:text-white transition-colors flex-shrink-0"
                            title="Copy Command"><span class="mdi mdi-content-copy"></span></button>
                    </div>
                </div>
                <div class="mt-8"><a href="?local=true"
                        class="inline-flex items-center text-sm font-medium text-cyan-600 dark:text-cyan-400 hover:underline">I've
                        started the script, connect now <span class="mdi mdi-arrow-right ml-1"></span></a></div>
            </div>

            <div v-if="localMode && !response.domain && !loading && bridgeConnected === false" class="max-w-2xl mx-auto mt-16 animate-fade-in-up">
                <div class="bg-red-50 dark:bg-red-900/20 border-l-4 border-red-500 p-4 rounded-md shadow-sm mb-8">
                    <div class="flex">
                        <div class="flex-shrink-0"><span class="mdi mdi-lan-disconnect text-red-500"></span></div>
                        <div class="ml-3">
                            <p class="text-sm font-medium text-red-700 dark:text-red-200">Network Connection Failed</p>
                            <p class="text-xs text-red-600 dark:text-red-300 mt-1">Unable to connect to local bridge at 127.0.0.1:8989</p>
                        </div>
                    </div>
                </div>
                <div class="text-center">
                    <h2 class="text-2xl font-bold text-slate-900 dark:text-white mb-4">Run searches locally</h2>
                    <p class="text-slate-600 dark:text-slate-400 mb-8">Periscope connects to your local terminal to run
                        `dig` and `whois` commands securely.</p>
                    <div class="relative group text-left mx-auto max-w-xl">
                        <div
                            class="absolute -inset-0.5 bg-gradient-to-r from-cyan-500 to-blue-500 rounded-lg blur opacity-30 group-hover:opacity-60 transition duration-1000 group-hover:duration-200">
                        </div>
                        <div
                            class="relative bg-slate-900 rounded-lg p-4 shadow-2xl border border-slate-800 flex items-center justify-between overflow-hidden">
                            <div class="overflow-x-auto custom-scroll mr-2"><code
                                    class="font-mono text-cyan-400 text-sm sm:text-base whitespace-nowrap">curl -sL https://periscope.run/boot.sh | bash</code>
                            </div>
                            <button @click="copyInstallCmd"
                                class="p-2 text-slate-500 hover:text-white transition-colors flex-shrink-0"
                                title="Copy Command"><span class="mdi mdi-content-copy"></span></button>
                        </div>
                    </div>
                    <div class="mt-8">
                        <button @click="checkBridgeCapabilities"
                            class="inline-flex items-center text-sm font-medium text-cyan-600 dark:text-cyan-400 hover:underline">
                            <span class="mdi mdi-refresh mr-1"></span> Retry connection
                        </button>
                    </div>
                </div>
            </div>

            <div v-if="localMode && !response.domain && !loading && bridgeConnected === true" class="mt-20 text-center animate-pulse">
                <div class="text-slate-400 dark:text-slate-600 text-sm flex flex-col items-center gap-2">
                    <span class="mdi mdi-lan-connect text-4xl text-cyan-500"></span>
                    <p class="font-medium text-slate-600 dark:text-slate-300">Local Bridge Active</p>
                    <p class="text-xs opacity-75">Waiting for target coordinates...</p>
                </div>
            </div>

            <div v-if="localMode && !response.domain && !loading && bridgeConnected === null" class="mt-20 text-center animate-pulse">
                <div class="text-slate-400 dark:text-slate-600 text-sm flex flex-col items-center gap-2">
                    <span class="mdi mdi-lan-pending text-4xl text-slate-400"></span>
                    <p class="font-medium text-slate-600 dark:text-slate-300">Connecting to Local Bridge...</p>
                </div>
            </div>

            <!-- Domain Does Not Exist -->
            <div v-if="response.domain_exists === false" class="animate-fade-in-up">
                <div class="mb-6 flex justify-center items-center gap-4">
                    <span v-if="response.timestamp" class="text-sm text-slate-500 dark:text-slate-400">
                        <span class="mdi mdi-clock-outline mr-1"></span>
                        {{ new Date(response.timestamp * 1000).toLocaleString() }}
                    </span>
                    <button v-if="otherVersions.length > 0" @click="showVersionsModal = true"
                        class="inline-flex items-center px-3 py-1 rounded-full text-xs font-medium bg-cyan-50 text-cyan-700 dark:bg-cyan-900/30 dark:text-cyan-300 hover:bg-cyan-100 dark:hover:bg-cyan-900/50 transition-colors border border-cyan-200 dark:border-cyan-800/50">
                        <span class="mdi mdi-history mr-1"></span> {{ otherVersions.length }} other scans
                    </button>
                </div>
                <div class="max-w-xl mx-auto text-center py-16">
                    <div class="mb-6">
                        <span class="mdi mdi-domain-off text-7xl text-slate-300 dark:text-slate-600"></span>
                    </div>
                    <h2 class="text-2xl font-bold text-slate-700 dark:text-slate-200 mb-3">Domain Not Registered</h2>
                    <p class="text-slate-500 dark:text-slate-400 mb-2">
                        The domain <span class="font-mono font-medium text-slate-700 dark:text-slate-300">{{ response.root_domain }}</span> does not exist.
                    </p>
                    <p class="text-sm text-slate-400 dark:text-slate-500">
                        This domain is not currently registered with any registrar.
                    </p>
                </div>
            </div>

            <div v-if="response.timestamp && response.domain_exists !== false" class="animate-fade-in-up">
                <div class="mb-6 flex justify-center items-center gap-4">
                    <span v-if="response.timestamp" class="text-sm text-slate-500 dark:text-slate-400">
                        <span class="mdi mdi-clock-outline mr-1"></span>
                        {{ new Date(response.timestamp * 1000).toLocaleString() }}
                    </span>
                    <button v-if="otherVersions.length > 0" @click="showVersionsModal = true"
                        class="inline-flex items-center px-3 py-1 rounded-full text-xs font-medium bg-cyan-50 text-cyan-700 dark:bg-cyan-900/30 dark:text-cyan-300 hover:bg-cyan-100 dark:hover:bg-cyan-900/50 transition-colors border border-cyan-200 dark:border-cyan-800/50">
                        <span class="mdi mdi-history mr-1"></span> {{ otherVersions.length }} other scans
                    </button>
                </div>

                <!-- Subdomain indicator -->
                <div v-if="response.is_subdomain" class="mb-6 flex justify-center">
                    <div class="inline-flex items-center gap-3 px-4 py-2 rounded-lg bg-indigo-50 dark:bg-indigo-900/20 border border-indigo-200 dark:border-indigo-800/50 text-sm">
                        <span class="text-indigo-600 dark:text-indigo-400">
                            <span class="mdi mdi-subdirectory-arrow-right mr-1"></span>
                            Scanning subdomain
                        </span>
                        <span class="font-mono font-medium text-indigo-700 dark:text-indigo-300">{{ response.target_host }}</span>
                        <span class="text-indigo-400 dark:text-indigo-500">of</span>
                        <span class="font-mono text-indigo-600 dark:text-indigo-400">{{ response.root_domain }}</span>
                    </div>
                </div>

                <!-- Redirect chain indicator -->
                <div v-if="response.redirect_chain && response.redirect_chain.length > 1" class="mb-6 flex justify-center">
                    <div class="inline-flex flex-wrap items-center justify-center gap-2 px-4 py-2.5 rounded-lg text-sm"
                        :class="isCrossDomainRedirect
                            ? 'bg-amber-50 dark:bg-amber-900/20 border border-amber-200 dark:border-amber-800/50'
                            : 'bg-slate-50 dark:bg-slate-800/50 border border-slate-200 dark:border-slate-700/50'">
                        <span :class="isCrossDomainRedirect ? 'text-amber-600 dark:text-amber-400' : 'text-slate-500 dark:text-slate-400'">
                            <span class="mdi mdi-redirect mr-1"></span>
                            Redirects
                        </span>
                        <template v-for="(hop, index) in response.redirect_chain" :key="index">
                            <span class="inline-flex items-center gap-1.5">
                                <span class="font-mono font-medium"
                                    :class="isCrossDomainRedirect ? 'text-amber-700 dark:text-amber-300' : 'text-slate-700 dark:text-slate-300'">{{ getHostFromUrl(hop.url) }}</span>
                                <span class="px-1.5 py-0.5 rounded text-[10px] font-bold"
                                    :class="{
                                        'bg-emerald-100 text-emerald-700 dark:bg-emerald-900/40 dark:text-emerald-400': hop.status_code === 200,
                                        'bg-cyan-100 text-cyan-700 dark:bg-cyan-900/40 dark:text-cyan-400': hop.status_code === 301 || hop.status_code === 308,
                                        'bg-amber-100 text-amber-700 dark:bg-amber-900/40 dark:text-amber-400': hop.status_code === 302 || hop.status_code === 303 || hop.status_code === 307,
                                        'bg-red-100 text-red-700 dark:bg-red-900/40 dark:text-red-400': hop.status_code >= 400
                                    }">{{ hop.status_code }}</span>
                            </span>
                            <span v-if="index < response.redirect_chain.length - 1"
                                :class="isCrossDomainRedirect ? 'text-amber-400 dark:text-amber-600' : 'text-slate-400 dark:text-slate-600'"
                                class="mdi mdi-arrow-right"></span>
                        </template>
                    </div>
                </div>

                <!-- Search engine blocking warning -->
                <div v-if="response.indexability && response.indexability.blocked" class="mb-6 flex justify-center">
                    <div class="inline-flex flex-wrap items-center justify-center gap-2 px-4 py-2.5 rounded-lg text-sm bg-red-50 dark:bg-red-900/20 border border-red-200 dark:border-red-800/50">
                        <span class="text-red-600 dark:text-red-400 font-medium">
                            <span class="mdi mdi-eye-off mr-1"></span>
                            Hidden from Search Engines
                        </span>
                        <span class="text-red-500 dark:text-red-400 text-xs">
                            ({{ response.indexability.reasons.map(r => r.detail).join(', ') }})
                        </span>
                    </div>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-6">
                    <div v-if="response.ssl && response.ssl.valid"
                        class="bg-white dark:bg-slate-900 rounded-xl shadow-sm border border-slate-200 dark:border-slate-800 overflow-hidden">
                        <div class="px-5 py-4 border-b border-slate-100 dark:border-slate-800 bg-slate-50/50 dark:bg-slate-950/30">
                            <h3 class="text-sm font-semibold text-slate-900 dark:text-cyan-50 uppercase tracking-wider">
                                <span class="mdi mdi-lock mr-1"></span> SSL Certificate
                            </h3>
                        </div>
                        <div class="p-5">
                            <div class="grid grid-cols-3 gap-4 text-sm">
                                <div>
                                    <p class="text-slate-500 dark:text-slate-400 mb-1">Expires</p>
                                    <p class="font-mono" :class="response.ssl.days_remaining < 30 ? 'text-amber-600 dark:text-amber-400' : 'text-slate-900 dark:text-slate-200'">
                                        {{ response.ssl.expires }}
                                    </p>
                                </div>
                                <div>
                                    <p class="text-slate-500 dark:text-slate-400 mb-1">Days Left</p>
                                    <p class="font-mono text-lg font-bold" :class="{
                                        'text-red-600 dark:text-red-400': response.ssl.days_remaining < 14,
                                        'text-amber-600 dark:text-amber-400': response.ssl.days_remaining >= 14 && response.ssl.days_remaining < 30,
                                        'text-emerald-600 dark:text-emerald-400': response.ssl.days_remaining >= 30
                                    }">
                                        {{ response.ssl.days_remaining }}
                                    </p>
                                </div>
                                <div v-if="response.ssl.issuer">
                                    <p class="text-slate-500 dark:text-slate-400 mb-1">Issuer</p>
                                    <p class="font-mono text-slate-900 dark:text-slate-200 truncate" :title="response.ssl.issuer">{{ response.ssl.issuer }}</p>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div v-if="(response.cms && !Array.isArray(response.cms)) || (response.raw_available && response.domain_exists !== false)" class="bg-white dark:bg-slate-900 rounded-xl shadow-sm border border-slate-200 dark:border-slate-800 overflow-hidden">
                        <div class="px-5 py-4 border-b border-slate-100 dark:border-slate-800 bg-slate-50/50 dark:bg-slate-950/30">
                            <h3 class="text-sm font-semibold text-slate-900 dark:text-cyan-50 uppercase tracking-wider">
                                <span class="mdi mdi-application-cog mr-1"></span> Platform
                            </h3>
                        </div>
                        <div class="p-5 flex items-center justify-between">
                            <span class="flex items-center gap-2">
                                <span class="text-lg font-medium text-slate-900 dark:text-slate-200">{{ response.cms ? response.cms.name : 'HTML' }}</span>
                                <button v-if="response.cms && response.cms.name === 'WordPress' && response.cms.plugins && response.cms.plugins.length > 0"
                                    @click="showPluginsModal = true"
                                    class="p-1 text-slate-400 hover:text-cyan-600 dark:hover:text-cyan-400 transition-colors"
                                    :title="response.cms.plugins.length + ' plugins detected'">
                                    <span class="mdi mdi-puzzle-outline"></span>
                                </button>
                                <a v-if="response.cms && response.cms.multisite"
                                    href="https://developer.wordpress.org/advanced-administration/multisite/"
                                    target="_blank"
                                    class="text-xs px-2 py-0.5 rounded-full bg-purple-100 dark:bg-purple-900/30 text-purple-700 dark:text-purple-300 hover:bg-purple-200 dark:hover:bg-purple-900/50 transition-colors"
                                    title="WordPress Multisite detected">
                                    Multisite
                                </a>
                                <a v-if="response.cms && response.cms.multitenancy"
                                    href="https://wpfreighter.com"
                                    target="_blank"
                                    class="text-xs px-2 py-0.5 rounded-full bg-amber-100 dark:bg-amber-900/30 text-amber-700 dark:text-amber-300 hover:bg-amber-200 dark:hover:bg-amber-900/50 transition-colors"
                                    title="WP Freighter Multi-tenant detected">
                                    Multi-tenant
                                </a>
                            </span>
                            <span v-if="response.cms && response.cms.version" class="font-mono text-sm px-3 py-1 rounded-lg bg-slate-100 dark:bg-slate-800 text-slate-600 dark:text-slate-400">
                                v{{ response.cms.version }}
                            </span>
                        </div>
                    </div>

                    <div v-if="response.infrastructure && !Array.isArray(response.infrastructure) && (response.infrastructure.host || response.infrastructure.cdn || response.infrastructure.server)"
                        class="bg-white dark:bg-slate-900 rounded-xl shadow-sm border border-slate-200 dark:border-slate-800 overflow-hidden">
                        <div class="px-5 py-4 border-b border-slate-100 dark:border-slate-800 bg-slate-50/50 dark:bg-slate-950/30">
                            <h3 class="text-sm font-semibold text-slate-900 dark:text-cyan-50 uppercase tracking-wider">
                                <span class="mdi mdi-server mr-1"></span> Infrastructure
                            </h3>
                        </div>
                        <div class="p-5">
                            <div class="grid grid-cols-3 gap-4 text-sm">
                                <div v-if="response.infrastructure.host">
                                    <p class="text-slate-500 dark:text-slate-400 mb-1">Host</p>
                                    <p class="font-medium text-slate-900 dark:text-slate-200">{{ response.infrastructure.host }}</p>
                                </div>
                                <div v-if="response.infrastructure.cdn">
                                    <p class="text-slate-500 dark:text-slate-400 mb-1">CDN</p>
                                    <p class="font-medium text-slate-900 dark:text-slate-200">{{ response.infrastructure.cdn }}</p>
                                </div>
                                <div v-if="response.infrastructure.server">
                                    <p class="text-slate-500 dark:text-slate-400 mb-1">Server</p>
                                    <p class="font-mono text-slate-900 dark:text-slate-200">{{ response.infrastructure.server }}</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Security, Technology, and Metadata Row -->
                <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-6">
                    <!-- Security Headers -->
                    <div v-if="response.security && response.security.score"
                        class="bg-white dark:bg-slate-900 rounded-xl shadow-sm border border-slate-200 dark:border-slate-800 overflow-hidden">
                        <div class="px-5 py-4 border-b border-slate-100 dark:border-slate-800 bg-slate-50/50 dark:bg-slate-950/30 flex justify-between items-center">
                            <h3 class="text-sm font-semibold text-slate-900 dark:text-cyan-50 uppercase tracking-wider">
                                <span class="mdi mdi-shield-check mr-1"></span> Security Headers
                            </h3>
                            <span class="text-xs font-bold px-2 py-1 rounded-full" :class="{
                                'bg-red-100 text-red-700 dark:bg-red-900/30 dark:text-red-400': response.security.score.value <= 2,
                                'bg-amber-100 text-amber-700 dark:bg-amber-900/30 dark:text-amber-400': response.security.score.value > 2 && response.security.score.value <= 4,
                                'bg-emerald-100 text-emerald-700 dark:bg-emerald-900/30 dark:text-emerald-400': response.security.score.value > 4
                            }">{{ response.security.score.value }}/{{ response.security.score.total }}</span>
                        </div>
                        <div class="p-4 space-y-2 text-xs">
                            <div class="flex items-center justify-between">
                                <span class="text-slate-600 dark:text-slate-400">HSTS</span>
                                <span v-if="response.security.hsts.present" class="text-emerald-600 dark:text-emerald-400"><span class="mdi mdi-check-circle"></span></span>
                                <span v-else class="text-slate-300 dark:text-slate-600"><span class="mdi mdi-close-circle"></span></span>
                            </div>
                            <div class="flex items-center justify-between">
                                <span class="text-slate-600 dark:text-slate-400">CSP</span>
                                <span v-if="response.security.csp.present" class="text-emerald-600 dark:text-emerald-400"><span class="mdi mdi-check-circle"></span></span>
                                <span v-else class="text-slate-300 dark:text-slate-600"><span class="mdi mdi-close-circle"></span></span>
                            </div>
                            <div class="flex items-center justify-between">
                                <span class="text-slate-600 dark:text-slate-400">X-Frame-Options</span>
                                <span v-if="response.security.x_frame_options.present" class="text-emerald-600 dark:text-emerald-400"><span class="mdi mdi-check-circle"></span></span>
                                <span v-else class="text-slate-300 dark:text-slate-600"><span class="mdi mdi-close-circle"></span></span>
                            </div>
                            <div class="flex items-center justify-between">
                                <span class="text-slate-600 dark:text-slate-400">X-Content-Type-Options</span>
                                <span v-if="response.security.x_content_type_options.present" class="text-emerald-600 dark:text-emerald-400"><span class="mdi mdi-check-circle"></span></span>
                                <span v-else class="text-slate-300 dark:text-slate-600"><span class="mdi mdi-close-circle"></span></span>
                            </div>
                            <div class="flex items-center justify-between">
                                <span class="text-slate-600 dark:text-slate-400">Referrer-Policy</span>
                                <span v-if="response.security.referrer_policy.present" class="text-emerald-600 dark:text-emerald-400"><span class="mdi mdi-check-circle"></span></span>
                                <span v-else class="text-slate-300 dark:text-slate-600"><span class="mdi mdi-close-circle"></span></span>
                            </div>
                            <div class="flex items-center justify-between">
                                <span class="text-slate-600 dark:text-slate-400">Permissions-Policy</span>
                                <span v-if="response.security.permissions_policy.present" class="text-emerald-600 dark:text-emerald-400"><span class="mdi mdi-check-circle"></span></span>
                                <span v-else class="text-slate-300 dark:text-slate-600"><span class="mdi mdi-close-circle"></span></span>
                            </div>
                        </div>
                    </div>

                    <!-- Technology Stack -->
                    <div v-if="response.technology && !Array.isArray(response.technology) && (response.technology.frameworks?.length > 0 || response.technology.analytics?.length > 0 || response.technology.ecommerce?.length > 0 || response.technology.widgets?.length > 0)"
                        class="bg-white dark:bg-slate-900 rounded-xl shadow-sm border border-slate-200 dark:border-slate-800 overflow-hidden">
                        <div class="px-5 py-4 border-b border-slate-100 dark:border-slate-800 bg-slate-50/50 dark:bg-slate-950/30">
                            <h3 class="text-sm font-semibold text-slate-900 dark:text-cyan-50 uppercase tracking-wider">
                                <span class="mdi mdi-code-tags mr-1"></span> Technology
                            </h3>
                        </div>
                        <div class="p-4 space-y-3 text-xs">
                            <div v-if="response.technology.frameworks.length > 0">
                                <p class="text-slate-500 dark:text-slate-400 mb-1 font-medium">Frameworks</p>
                                <div class="flex flex-wrap gap-1">
                                    <span v-for="fw in response.technology.frameworks" :key="fw" class="px-2 py-0.5 bg-cyan-50 dark:bg-cyan-900/20 text-cyan-700 dark:text-cyan-300 rounded">{{ fw }}</span>
                                </div>
                            </div>
                            <div v-if="response.technology.analytics.length > 0">
                                <p class="text-slate-500 dark:text-slate-400 mb-1 font-medium">Analytics</p>
                                <div class="flex flex-wrap gap-1">
                                    <span v-for="a in response.technology.analytics" :key="a.name" class="px-2 py-0.5 bg-purple-50 dark:bg-purple-900/20 text-purple-700 dark:text-purple-300 rounded">{{ a.name }}<span v-if="a.id" class="opacity-60 ml-1">({{ a.id }})</span></span>
                                </div>
                            </div>
                            <div v-if="response.technology.ecommerce.length > 0">
                                <p class="text-slate-500 dark:text-slate-400 mb-1 font-medium">E-commerce</p>
                                <div class="flex flex-wrap gap-1">
                                    <span v-for="ec in response.technology.ecommerce" :key="ec" class="px-2 py-0.5 bg-emerald-50 dark:bg-emerald-900/20 text-emerald-700 dark:text-emerald-300 rounded">{{ ec }}</span>
                                </div>
                            </div>
                            <div v-if="response.technology.widgets.length > 0">
                                <p class="text-slate-500 dark:text-slate-400 mb-1 font-medium">Widgets</p>
                                <div class="flex flex-wrap gap-1">
                                    <span v-for="w in response.technology.widgets" :key="w" class="px-2 py-0.5 bg-amber-50 dark:bg-amber-900/20 text-amber-700 dark:text-amber-300 rounded">{{ w }}</span>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Metadata -->
                    <div v-if="response.metadata && !Array.isArray(response.metadata) && Object.keys(response.metadata).length > 0"
                        class="bg-white dark:bg-slate-900 rounded-xl shadow-sm border border-slate-200 dark:border-slate-800 overflow-hidden">
                        <div class="px-5 py-4 border-b border-slate-100 dark:border-slate-800 bg-slate-50/50 dark:bg-slate-950/30">
                            <h3 class="text-sm font-semibold text-slate-900 dark:text-cyan-50 uppercase tracking-wider">
                                <span class="mdi mdi-file-document-outline mr-1"></span> Metadata
                            </h3>
                        </div>
                        <div class="p-4 space-y-2 text-xs">
                            <!-- Found items -->
                            <div v-if="response.metadata.robots_txt && response.metadata.robots_txt.present" class="flex items-center justify-between">
                                <span class="flex items-center gap-1">
                                    <span class="text-slate-600 dark:text-slate-400">robots.txt</span>
                                    <button v-if="response.metadata.robots_txt.raw_stored" @click="showRawPreview('robots_txt', 'robots.txt')" class="text-cyan-600 dark:text-cyan-400 hover:text-cyan-700 dark:hover:text-cyan-300" title="Preview">
                                        <span class="mdi mdi-eye-outline"></span>
                                    </button>
                                </span>
                                <span class="text-emerald-600 dark:text-emerald-400">
                                    <span class="mdi mdi-check-circle"></span>
                                    <span v-if="response.metadata.robots_txt.disallow_count > 0" class="ml-1 text-slate-500">({{ response.metadata.robots_txt.disallow_count }} rules)</span>
                                </span>
                            </div>
                            <div v-if="response.metadata.sitemap && response.metadata.sitemap.present" class="flex items-center justify-between">
                                <span class="flex items-center gap-1">
                                    <span class="text-slate-600 dark:text-slate-400">sitemap.xml</span>
                                    <button v-if="response.metadata.sitemap.raw_stored" @click="showRawPreview('sitemap_xml', 'sitemap.xml')" class="text-cyan-600 dark:text-cyan-400 hover:text-cyan-700 dark:hover:text-cyan-300" title="Preview">
                                        <span class="mdi mdi-eye-outline"></span>
                                    </button>
                                </span>
                                <span class="text-emerald-600 dark:text-emerald-400"><span class="mdi mdi-check-circle"></span></span>
                            </div>
                            <div v-if="response.metadata.security_txt && response.metadata.security_txt.present" class="flex items-center justify-between">
                                <span class="flex items-center gap-1">
                                    <span class="text-slate-600 dark:text-slate-400">security.txt</span>
                                    <button v-if="response.metadata.security_txt.raw_stored" @click="showRawPreview('security_txt', 'security.txt')" class="text-cyan-600 dark:text-cyan-400 hover:text-cyan-700 dark:hover:text-cyan-300" title="Preview">
                                        <span class="mdi mdi-eye-outline"></span>
                                    </button>
                                </span>
                                <span class="text-emerald-600 dark:text-emerald-400"><span class="mdi mdi-check-circle"></span></span>
                            </div>
                            <div v-if="response.metadata.ads_txt && response.metadata.ads_txt.present" class="flex items-center justify-between">
                                <span class="flex items-center gap-1">
                                    <span class="text-slate-600 dark:text-slate-400">ads.txt</span>
                                    <button v-if="response.metadata.ads_txt.raw_stored" @click="showRawPreview('ads_txt', 'ads.txt')" class="text-cyan-600 dark:text-cyan-400 hover:text-cyan-700 dark:hover:text-cyan-300" title="Preview">
                                        <span class="mdi mdi-eye-outline"></span>
                                    </button>
                                </span>
                                <span class="text-emerald-600 dark:text-emerald-400">
                                    <span class="mdi mdi-check-circle"></span>
                                    <span v-if="response.metadata.ads_txt.seller_count" class="ml-1 text-slate-500">({{ response.metadata.ads_txt.seller_count }} sellers)</span>
                                </span>
                            </div>
                            <div v-if="response.metadata.app_ads_txt && response.metadata.app_ads_txt.present" class="flex items-center justify-between">
                                <span class="flex items-center gap-1">
                                    <span class="text-slate-600 dark:text-slate-400">app-ads.txt</span>
                                    <button v-if="response.metadata.app_ads_txt.raw_stored" @click="showRawPreview('app_ads_txt', 'app-ads.txt')" class="text-cyan-600 dark:text-cyan-400 hover:text-cyan-700 dark:hover:text-cyan-300" title="Preview">
                                        <span class="mdi mdi-eye-outline"></span>
                                    </button>
                                </span>
                                <span class="text-emerald-600 dark:text-emerald-400">
                                    <span class="mdi mdi-check-circle"></span>
                                    <span v-if="response.metadata.app_ads_txt.seller_count" class="ml-1 text-slate-500">({{ response.metadata.app_ads_txt.seller_count }} sellers)</span>
                                </span>
                            </div>
                            <div v-if="response.metadata.app_site_association && response.metadata.app_site_association.present" class="flex items-center justify-between">
                                <span class="flex items-center gap-1">
                                    <span class="text-slate-600 dark:text-slate-400">apple-app-site-association</span>
                                    <button v-if="response.metadata.app_site_association.raw_stored" @click="showRawPreview('app_site_association', 'apple-app-site-association')" class="text-cyan-600 dark:text-cyan-400 hover:text-cyan-700 dark:hover:text-cyan-300" title="Preview">
                                        <span class="mdi mdi-eye-outline"></span>
                                    </button>
                                </span>
                                <span class="text-emerald-600 dark:text-emerald-400">
                                    <span class="mdi mdi-check-circle"></span>
                                    <span v-if="response.metadata.app_site_association.app_ids && response.metadata.app_site_association.app_ids.length" class="ml-1 text-slate-500">({{ response.metadata.app_site_association.app_ids.length }} apps)</span>
                                </span>
                            </div>
                            <div v-if="response.metadata.assetlinks && response.metadata.assetlinks.present" class="flex items-center justify-between">
                                <span class="flex items-center gap-1">
                                    <span class="text-slate-600 dark:text-slate-400">assetlinks.json</span>
                                    <button v-if="response.metadata.assetlinks.raw_stored" @click="showRawPreview('assetlinks', 'assetlinks.json')" class="text-cyan-600 dark:text-cyan-400 hover:text-cyan-700 dark:hover:text-cyan-300" title="Preview">
                                        <span class="mdi mdi-eye-outline"></span>
                                    </button>
                                </span>
                                <span class="text-emerald-600 dark:text-emerald-400">
                                    <span class="mdi mdi-check-circle"></span>
                                    <span v-if="response.metadata.assetlinks.packages && response.metadata.assetlinks.packages.length" class="ml-1 text-slate-500">({{ response.metadata.assetlinks.packages.length }} apps)</span>
                                </span>
                            </div>
                            <div v-if="response.metadata.manifest && response.metadata.manifest.present" class="flex items-center justify-between">
                                <span class="flex items-center gap-1">
                                    <span class="text-slate-600 dark:text-slate-400">manifest.json</span>
                                    <button v-if="response.metadata.manifest.raw_stored" @click="showRawPreview('manifest', 'manifest.json')" class="text-cyan-600 dark:text-cyan-400 hover:text-cyan-700 dark:hover:text-cyan-300" title="Preview">
                                        <span class="mdi mdi-eye-outline"></span>
                                    </button>
                                </span>
                                <span class="text-emerald-600 dark:text-emerald-400">
                                    <span class="mdi mdi-check-circle"></span>
                                    <span v-if="response.metadata.manifest.display" class="ml-1 text-slate-500">({{ response.metadata.manifest.display }})</span>
                                </span>
                            </div>
                            <div v-if="response.metadata.webfinger && response.metadata.webfinger.present" class="flex items-center justify-between">
                                <span class="flex items-center gap-1">
                                    <span class="text-slate-600 dark:text-slate-400">webfinger</span>
                                </span>
                                <span class="text-emerald-600 dark:text-emerald-400">
                                    <span class="mdi mdi-check-circle"></span>
                                    <span class="ml-1 text-slate-500">(Fediverse)</span>
                                </span>
                            </div>
                            <div v-if="response.metadata.change_password && response.metadata.change_password.present" class="flex items-center justify-between">
                                <span class="flex items-center gap-1">
                                    <span class="text-slate-600 dark:text-slate-400">change-password</span>
                                </span>
                                <span class="text-emerald-600 dark:text-emerald-400">
                                    <span class="mdi mdi-check-circle"></span>
                                    <span v-if="response.metadata.change_password.status >= 300 && response.metadata.change_password.status < 400" class="ml-1 text-slate-500">(redirects)</span>
                                </span>
                            </div>
                            <div v-if="response.metadata.humans_txt && response.metadata.humans_txt.present" class="flex items-center justify-between">
                                <span class="flex items-center gap-1">
                                    <span class="text-slate-600 dark:text-slate-400">humans.txt</span>
                                    <button v-if="response.metadata.humans_txt.raw_stored" @click="showRawPreview('humans_txt', 'humans.txt')" class="text-cyan-600 dark:text-cyan-400 hover:text-cyan-700 dark:hover:text-cyan-300" title="Preview">
                                        <span class="mdi mdi-eye-outline"></span>
                                    </button>
                                </span>
                                <span class="text-emerald-600 dark:text-emerald-400"><span class="mdi mdi-check-circle"></span></span>
                            </div>
                            <div v-if="response.metadata.browserconfig && response.metadata.browserconfig.present" class="flex items-center justify-between">
                                <span class="flex items-center gap-1">
                                    <span class="text-slate-600 dark:text-slate-400">browserconfig.xml</span>
                                    <button v-if="response.metadata.browserconfig.raw_stored" @click="showRawPreview('browserconfig', 'browserconfig.xml')" class="text-cyan-600 dark:text-cyan-400 hover:text-cyan-700 dark:hover:text-cyan-300" title="Preview">
                                        <span class="mdi mdi-eye-outline"></span>
                                    </button>
                                </span>
                                <span class="text-emerald-600 dark:text-emerald-400"><span class="mdi mdi-check-circle"></span></span>
                            </div>
                            <div v-if="response.metadata.keybase_txt && response.metadata.keybase_txt.present" class="flex items-center justify-between">
                                <span class="flex items-center gap-1">
                                    <span class="text-slate-600 dark:text-slate-400">keybase.txt</span>
                                    <button v-if="response.metadata.keybase_txt.raw_stored" @click="showRawPreview('keybase_txt', 'keybase.txt')" class="text-cyan-600 dark:text-cyan-400 hover:text-cyan-700 dark:hover:text-cyan-300" title="Preview">
                                        <span class="mdi mdi-eye-outline"></span>
                                    </button>
                                </span>
                                <span class="text-emerald-600 dark:text-emerald-400">
                                    <span class="mdi mdi-check-circle"></span>
                                    <span v-if="response.metadata.keybase_txt.username" class="ml-1 text-slate-500">({{ response.metadata.keybase_txt.username }})</span>
                                </span>
                            </div>
                            <div v-if="response.metadata.meta_tags && response.metadata.meta_tags.open_graph" class="flex items-center justify-between">
                                <span class="flex items-center gap-1">
                                    <span class="text-slate-600 dark:text-slate-400">Open Graph</span>
                                    <button @click="showOgPreview = true" class="text-cyan-600 dark:text-cyan-400 hover:text-cyan-700 dark:hover:text-cyan-300" title="Preview">
                                        <span class="mdi mdi-image-outline"></span>
                                    </button>
                                </span>
                                <span class="text-emerald-600 dark:text-emerald-400"><span class="mdi mdi-check-circle"></span></span>
                            </div>
                            <div v-if="response.metadata.meta_tags && response.metadata.meta_tags.twitter" class="flex items-center justify-between">
                                <span class="flex items-center gap-1">
                                    <span class="text-slate-600 dark:text-slate-400">Twitter Card</span>
                                    <button @click="showTwitterPreview = true" class="text-cyan-600 dark:text-cyan-400 hover:text-cyan-700 dark:hover:text-cyan-300" title="Preview">
                                        <span class="mdi mdi-image-outline"></span>
                                    </button>
                                </span>
                                <span class="text-emerald-600 dark:text-emerald-400"><span class="mdi mdi-check-circle"></span></span>
                            </div>
                            <div v-if="response.metadata.favicon && response.metadata.favicon.present" class="flex items-center justify-between">
                                <span class="flex items-center gap-1">
                                    <span class="text-slate-600 dark:text-slate-400">Favicon</span>
                                    <button v-if="response.metadata.favicon.raw_stored" @click="showFaviconPreview = true" class="text-cyan-600 dark:text-cyan-400 hover:text-cyan-700 dark:hover:text-cyan-300" title="Preview">
                                        <span class="mdi mdi-image-outline"></span>
                                    </button>
                                </span>
                                <span class="text-emerald-600 dark:text-emerald-400">
                                    <span class="mdi mdi-check-circle"></span>
                                    <span v-if="response.metadata.favicon.hash" class="ml-1 font-mono text-slate-500">{{ response.metadata.favicon.hash.substring(0, 8) }}...</span>
                                </span>
                            </div>

                            <!-- Toggle for missing items -->
                            <button v-if="missingMetadataCount > 0" @click="showMissingMetadata = !showMissingMetadata" class="flex items-center gap-1 text-slate-400 hover:text-slate-600 dark:hover:text-slate-300 mt-2 pt-2 border-t border-slate-100 dark:border-slate-800 w-full">
                                <span class="mdi" :class="showMissingMetadata ? 'mdi-chevron-up' : 'mdi-chevron-down'"></span>
                                <span>{{ showMissingMetadata ? 'Hide' : 'Show' }} {{ missingMetadataCount }} not found</span>
                            </button>

                            <!-- Missing items (hidden by default) -->
                            <div v-if="showMissingMetadata" class="space-y-2 pt-2">
                                <div v-if="!response.metadata.robots_txt || !response.metadata.robots_txt.present" class="flex items-center justify-between">
                                    <span class="text-slate-600 dark:text-slate-400">robots.txt</span>
                                    <span class="text-slate-300 dark:text-slate-600"><span class="mdi mdi-close-circle"></span></span>
                                </div>
                                <div v-if="!response.metadata.sitemap || !response.metadata.sitemap.present" class="flex items-center justify-between">
                                    <span class="text-slate-600 dark:text-slate-400">sitemap.xml</span>
                                    <span class="text-slate-300 dark:text-slate-600"><span class="mdi mdi-close-circle"></span></span>
                                </div>
                                <div v-if="!response.metadata.security_txt || !response.metadata.security_txt.present" class="flex items-center justify-between">
                                    <span class="text-slate-600 dark:text-slate-400">security.txt</span>
                                    <span class="text-slate-300 dark:text-slate-600"><span class="mdi mdi-close-circle"></span></span>
                                </div>
                                <div v-if="!response.metadata.ads_txt || !response.metadata.ads_txt.present" class="flex items-center justify-between">
                                    <span class="text-slate-600 dark:text-slate-400">ads.txt</span>
                                    <span class="text-slate-300 dark:text-slate-600"><span class="mdi mdi-close-circle"></span></span>
                                </div>
                                <div v-if="!response.metadata.app_ads_txt || !response.metadata.app_ads_txt.present" class="flex items-center justify-between">
                                    <span class="text-slate-600 dark:text-slate-400">app-ads.txt</span>
                                    <span class="text-slate-300 dark:text-slate-600"><span class="mdi mdi-close-circle"></span></span>
                                </div>
                                <div v-if="!response.metadata.app_site_association || !response.metadata.app_site_association.present" class="flex items-center justify-between">
                                    <span class="text-slate-600 dark:text-slate-400">apple-app-site-association</span>
                                    <span class="text-slate-300 dark:text-slate-600"><span class="mdi mdi-close-circle"></span></span>
                                </div>
                                <div v-if="!response.metadata.assetlinks || !response.metadata.assetlinks.present" class="flex items-center justify-between">
                                    <span class="text-slate-600 dark:text-slate-400">assetlinks.json</span>
                                    <span class="text-slate-300 dark:text-slate-600"><span class="mdi mdi-close-circle"></span></span>
                                </div>
                                <div v-if="!response.metadata.manifest || !response.metadata.manifest.present" class="flex items-center justify-between">
                                    <span class="text-slate-600 dark:text-slate-400">manifest.json</span>
                                    <span class="text-slate-300 dark:text-slate-600"><span class="mdi mdi-close-circle"></span></span>
                                </div>
                                <div v-if="!response.metadata.webfinger || !response.metadata.webfinger.present" class="flex items-center justify-between">
                                    <span class="text-slate-600 dark:text-slate-400">webfinger</span>
                                    <span class="text-slate-300 dark:text-slate-600"><span class="mdi mdi-close-circle"></span></span>
                                </div>
                                <div v-if="!response.metadata.change_password || !response.metadata.change_password.present" class="flex items-center justify-between">
                                    <span class="text-slate-600 dark:text-slate-400">change-password</span>
                                    <span class="text-slate-300 dark:text-slate-600"><span class="mdi mdi-close-circle"></span></span>
                                </div>
                                <div v-if="!response.metadata.humans_txt || !response.metadata.humans_txt.present" class="flex items-center justify-between">
                                    <span class="text-slate-600 dark:text-slate-400">humans.txt</span>
                                    <span class="text-slate-300 dark:text-slate-600"><span class="mdi mdi-close-circle"></span></span>
                                </div>
                                <div v-if="!response.metadata.browserconfig || !response.metadata.browserconfig.present" class="flex items-center justify-between">
                                    <span class="text-slate-600 dark:text-slate-400">browserconfig.xml</span>
                                    <span class="text-slate-300 dark:text-slate-600"><span class="mdi mdi-close-circle"></span></span>
                                </div>
                                <div v-if="!response.metadata.keybase_txt || !response.metadata.keybase_txt.present" class="flex items-center justify-between">
                                    <span class="text-slate-600 dark:text-slate-400">keybase.txt</span>
                                    <span class="text-slate-300 dark:text-slate-600"><span class="mdi mdi-close-circle"></span></span>
                                </div>
                                <div v-if="!response.metadata.meta_tags || !response.metadata.meta_tags.open_graph" class="flex items-center justify-between">
                                    <span class="text-slate-600 dark:text-slate-400">Open Graph</span>
                                    <span class="text-slate-300 dark:text-slate-600"><span class="mdi mdi-close-circle"></span></span>
                                </div>
                                <div v-if="!response.metadata.meta_tags || !response.metadata.meta_tags.twitter" class="flex items-center justify-between">
                                    <span class="text-slate-600 dark:text-slate-400">Twitter Card</span>
                                    <span class="text-slate-300 dark:text-slate-600"><span class="mdi mdi-close-circle"></span></span>
                                </div>
                                <div v-if="!response.metadata.favicon || !response.metadata.favicon.present" class="flex items-center justify-between">
                                    <span class="text-slate-600 dark:text-slate-400">Favicon</span>
                                    <span class="text-slate-300 dark:text-slate-600"><span class="mdi mdi-close-circle"></span></span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-12 gap-6">
                    <div class="md:col-span-5 space-y-6">
                        <div
                            class="bg-white dark:bg-slate-900 rounded-xl shadow-sm border border-slate-200 dark:border-slate-800 overflow-hidden">
                            <div
                                class="px-5 py-4 border-b border-slate-100 dark:border-slate-800 flex justify-between items-center bg-slate-50/50 dark:bg-slate-950/30">
                                <div>
                                    <h3 class="text-sm font-semibold text-slate-900 dark:text-cyan-50 uppercase tracking-wider">
                                        Domain Registration</h3>
                                    <p v-if="response.is_subdomain" class="text-xs text-slate-500 dark:text-slate-400 mt-0.5">
                                        Root: {{ response.root_domain }}
                                    </p>
                                </div>
                                <button v-if="response.raw_available" @click="showRawWhois()"
                                    class="text-xs text-cyan-600 dark:text-cyan-400 hover:underline">View Raw</button>
                            </div>
                            <div class="divide-y divide-slate-100 dark:divide-slate-800">
                                <div v-for="record in response.domain" :key="record.name"
                                    class="px-5 py-3 grid grid-cols-3 gap-4 hover:bg-slate-50 dark:hover:bg-slate-800/30 transition-colors group">
                                    <dt class="text-sm font-medium text-slate-500 dark:text-slate-400">{{ record.name }}
                                    </dt>
                                    <dd class="text-sm text-slate-900 dark:text-slate-200 col-span-2 break-words font-mono"
                                        @contextmenu.prevent="showContextMenu($event, record.value)">{{ record.value }}
                                    </dd>
                                </div>
                            </div>
                        </div>

                        <div
                            class="bg-white dark:bg-slate-900 rounded-xl shadow-sm border border-slate-200 dark:border-slate-800 overflow-hidden">
                            <div
                                class="px-5 py-4 border-b border-slate-100 dark:border-slate-800 bg-slate-50/50 dark:bg-slate-950/30">
                                <h3
                                    class="text-sm font-semibold text-slate-900 dark:text-cyan-50 uppercase tracking-wider">
                                    Network Coordinates</h3>
                            </div>
                            <div class="p-5 space-y-6">
                                <template v-for="(rows, ip) in response.ip_lookup">
                                    <div
                                        class="bg-slate-50 dark:bg-slate-950 rounded-lg p-3 border border-slate-100 dark:border-slate-800">
                                        <div class="flex justify-between items-center mb-3">
                                            <div class="flex items-center gap-2"><span
                                                    class="h-2 w-2 rounded-full bg-emerald-500 shadow-[0_0_8px_rgba(16,185,129,0.5)]"></span><span
                                                    class="font-mono text-sm font-bold text-slate-700 dark:text-slate-200">{{
                                                    ip }}</span></div>
                                            <button @click="viewWhois(ip)"
                                                class="text-xs px-2 py-1 rounded bg-white dark:bg-slate-800 border border-slate-200 dark:border-slate-700 text-slate-600 dark:text-slate-300 hover:bg-slate-100 dark:hover:bg-slate-700">View WHOIS</button>
                                        </div>
                                        <div class="space-y-1">
                                            <div v-for="row in rows.split('\n').filter(r => r.split(':')[1] && r.split(':')[1].trim() && r.split(':')[1].trim() !== 'N/A')" class="grid grid-cols-3 gap-2 text-xs">
                                                <span class="text-slate-500 dark:text-slate-400">{{ row.split(":")[0]
                                                    }}</span>
                                                <span
                                                    class="col-span-2 text-slate-800 dark:text-slate-300 font-mono truncate"
                                                    :title="row.split(':')[1]"
                                                    @contextmenu.prevent="showContextMenu($event, row.split(':')[1])">{{
                                                    row.split(":")[1] }}</span>
                                            </div>
                                        </div>
                                        <!-- PTR Record (Reverse DNS) -->
                                        <div v-if="response.ptr_records && response.ptr_records[ip]" 
                                            class="mt-3 pt-3 border-t border-slate-200 dark:border-slate-700">
                                            <div class="grid grid-cols-3 gap-2 text-xs">
                                                <span class="text-slate-500 dark:text-slate-400">PTR</span>
                                                <div class="col-span-2 flex items-center gap-2">
                                                    <span class="text-slate-800 dark:text-slate-300 font-mono truncate"
                                                        :title="response.ptr_records[ip].ptr"
                                                        @contextmenu.prevent="showContextMenu($event, response.ptr_records[ip].ptr)">
                                                        {{ response.ptr_records[ip].ptr }}
                                                    </span>
                                                    <span v-if="response.ptr_records[ip].forward_match" 
                                                        class="inline-flex items-center gap-0.5 text-[10px] text-emerald-600 dark:text-emerald-400"
                                                        title="Forward lookup matches - PTR resolves back to this IP">
                                                        <span class="mdi mdi-check-circle"></span> Verified
                                                    </span>
                                                    <span v-else 
                                                        class="inline-flex items-center gap-0.5 text-[10px] text-amber-600 dark:text-amber-400"
                                                        title="Forward lookup mismatch - PTR does not resolve back to this IP">
                                                        <span class="mdi mdi-alert"></span> Mismatch
                                                    </span>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </template>
                            </div>
                        </div>

                        <div
                            class="bg-white dark:bg-slate-900 rounded-xl shadow-sm border border-slate-200 dark:border-slate-800 overflow-hidden">
                            <div
                                class="px-5 py-4 border-b border-slate-100 dark:border-slate-800 bg-slate-50/50 dark:bg-slate-950/30">
                                <h3
                                    class="text-sm font-semibold text-slate-900 dark:text-cyan-50 uppercase tracking-wider">
                                    Headers</h3>
                            </div>
                            <div class="overflow-x-auto">
                                <table class="min-w-full divide-y divide-slate-100 dark:divide-slate-800">
                                    <tbody class="divide-y divide-slate-100 dark:divide-slate-800">
                                        <tr v-for="(value, key) in response.http_headers"
                                            class="hover:bg-slate-50 dark:hover:bg-slate-800/30">
                                            <td
                                                class="px-5 py-2 text-xs font-medium text-slate-500 dark:text-slate-400 whitespace-nowrap">
                                                {{ key }}</td>
                                            <td class="px-5 py-2 text-xs font-mono text-slate-800 dark:text-slate-300 break-all"
                                                @contextmenu.prevent="showContextMenu($event, value)">{{ value }}</td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>

                    <div class="md:col-span-7 space-y-6">
                        <!-- SPF Analysis -->
                        <div v-if="spfAnalysis" class="bg-white dark:bg-slate-900 rounded-xl shadow-sm border border-slate-200 dark:border-slate-800 overflow-hidden">
                            <div class="px-5 py-4 border-b border-slate-100 dark:border-slate-800 bg-slate-50/50 dark:bg-slate-950/30 flex items-center justify-between">
                                <h3 class="text-sm font-semibold text-slate-900 dark:text-cyan-50 uppercase tracking-wider">
                                    SPF Analysis
                                </h3>
                                <div class="flex items-center gap-2">
                                    <span v-if="spfAnalysis.isValid && !spfAnalysis.hasWarnings"
                                        class="inline-flex items-center gap-1 text-xs font-medium text-emerald-600 dark:text-emerald-400">
                                        <span class="mdi mdi-check-circle"></span> Valid
                                    </span>
                                    <span v-else-if="spfAnalysis.isValid && spfAnalysis.hasWarnings"
                                        class="inline-flex items-center gap-1 text-xs font-medium text-amber-600 dark:text-amber-400">
                                        <span class="mdi mdi-alert"></span> Valid with warnings
                                    </span>
                                    <span v-else
                                        class="inline-flex items-center gap-1 text-xs font-medium text-red-600 dark:text-red-400">
                                        <span class="mdi mdi-close-circle"></span> Invalid
                                    </span>
                                    <span class="text-xs text-slate-500 dark:text-slate-400 font-mono">
                                        {{ spfAnalysis.dnsLookups }}/10 lookups
                                    </span>
                                </div>
                            </div>

                            <!-- Errors -->
                            <div v-if="spfAnalysis.errors.length > 0" class="px-5 py-3 bg-red-50 dark:bg-red-900/20 border-b border-red-100 dark:border-red-900/30">
                                <div v-for="error in spfAnalysis.errors" class="flex items-start gap-2 text-sm text-red-700 dark:text-red-300">
                                    <span class="mdi mdi-close-circle mt-0.5 flex-shrink-0"></span>
                                    <span>{{ error }}</span>
                                </div>
                            </div>

                            <!-- Warnings -->
                            <div v-if="spfAnalysis.warnings.length > 0" class="px-5 py-3 bg-amber-50 dark:bg-amber-900/20 border-b border-amber-100 dark:border-amber-900/30">
                                <div v-for="warning in spfAnalysis.warnings" class="flex items-start gap-2 text-sm text-amber-700 dark:text-amber-300">
                                    <span class="mdi mdi-alert mt-0.5 flex-shrink-0"></span>
                                    <span>{{ warning }}</span>
                                </div>
                            </div>

                            <!-- Mechanisms breakdown -->
                            <div class="divide-y divide-slate-100 dark:divide-slate-800">
                                <div v-for="m in spfAnalysis.mechanisms" :key="m.raw"
                                    class="px-5 py-3 flex items-center gap-4 hover:bg-slate-50 dark:hover:bg-slate-800/30 transition-colors">
                                    <div class="flex-shrink-0 w-8 text-center">
                                        <span v-if="m.type === 'version'" class="mdi mdi-tag text-slate-400"></span>
                                        <span v-else-if="m.type === 'include'" class="mdi mdi-call-merge text-cyan-500"></span>
                                        <span v-else-if="m.type === 'ip4' || m.type === 'ip6'" class="mdi mdi-ip text-emerald-500"></span>
                                        <span v-else-if="m.type === 'a'" class="mdi mdi-alpha-a-circle text-blue-500"></span>
                                        <span v-else-if="m.type === 'mx'" class="mdi mdi-email text-purple-500"></span>
                                        <span v-else-if="m.type === 'all'" class="mdi mdi-shield text-slate-500"></span>
                                        <span v-else-if="m.type === 'redirect'" class="mdi mdi-arrow-right-bold text-orange-500"></span>
                                        <span v-else class="mdi mdi-cog text-slate-400"></span>
                                    </div>
                                    <div class="flex-1 min-w-0">
                                        <div class="flex items-center gap-2">
                                            <code class="text-xs font-mono text-slate-700 dark:text-slate-300">{{ m.raw }}</code>
                                            <span v-if="m.provider"
                                                class="inline-flex items-center px-1.5 py-0.5 rounded text-[10px] font-medium bg-cyan-100 dark:bg-cyan-900/30 text-cyan-700 dark:text-cyan-300">
                                                {{ m.provider }}
                                            </span>
                                            <span v-if="m.isDnsLookup"
                                                class="inline-flex items-center gap-0.5 text-[10px] text-slate-400" title="Requires DNS lookup">
                                                <span class="mdi mdi-dns"></span>
                                            </span>
                                        </div>
                                        <p class="text-xs text-slate-500 dark:text-slate-400 mt-0.5">{{ m.description }}</p>
                                    </div>
                                    <div v-if="m.qualifier && m.type !== 'version'" class="flex-shrink-0">
                                        <span class="text-xs font-mono px-1.5 py-0.5 rounded"
                                            :class="{
                                                'bg-emerald-100 dark:bg-emerald-900/30 text-emerald-700 dark:text-emerald-300': m.qualifier === '+',
                                                'bg-red-100 dark:bg-red-900/30 text-red-700 dark:text-red-300': m.qualifier === '-',
                                                'bg-amber-100 dark:bg-amber-900/30 text-amber-700 dark:text-amber-300': m.qualifier === '~',
                                                'bg-slate-100 dark:bg-slate-800 text-slate-600 dark:text-slate-400': m.qualifier === '?'
                                            }">
                                            {{ m.qualifierDesc }}
                                        </span>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Email Health -->
                        <div v-if="emailHealthAnalysis" class="bg-white dark:bg-slate-900 rounded-xl shadow-sm border border-slate-200 dark:border-slate-800 overflow-hidden">
                            <div class="px-5 py-4 border-b border-slate-100 dark:border-slate-800 bg-slate-50/50 dark:bg-slate-950/30 flex items-center justify-between">
                                <h3 class="text-sm font-semibold text-slate-900 dark:text-cyan-50 uppercase tracking-wider">
                                    Email Health
                                </h3>
                                <div class="flex items-center gap-3">
                                    <span class="text-2xl font-bold"
                                        :class="{
                                            'text-emerald-600 dark:text-emerald-400': emailHealthAnalysis.grade === 'A',
                                            'text-cyan-600 dark:text-cyan-400': emailHealthAnalysis.grade === 'B',
                                            'text-amber-600 dark:text-amber-400': emailHealthAnalysis.grade === 'C',
                                            'text-orange-600 dark:text-orange-400': emailHealthAnalysis.grade === 'D',
                                            'text-red-600 dark:text-red-400': emailHealthAnalysis.grade === 'F'
                                        }">
                                        {{ emailHealthAnalysis.grade }}
                                    </span>
                                    <span class="text-sm text-slate-500 dark:text-slate-400 font-mono">
                                        {{ emailHealthAnalysis.totalScore }}/{{ emailHealthAnalysis.maxScore }}
                                    </span>
                                </div>
                            </div>

                            <!-- Score Breakdown -->
                            <div class="divide-y divide-slate-100 dark:divide-slate-800">
                                <!-- MX Records -->
                                <div class="px-5 py-3 flex items-center gap-4">
                                    <div class="flex-shrink-0 w-8 text-center">
                                        <span class="mdi mdi-email text-purple-500"></span>
                                    </div>
                                    <div class="flex-1 min-w-0">
                                        <div class="flex items-center gap-2">
                                            <span class="text-sm font-medium text-slate-700 dark:text-slate-300">MX Records</span>
                                        </div>
                                        <p class="text-xs text-slate-500 dark:text-slate-400 mt-0.5">
                                            {{ emailHealthAnalysis.mxCount }} mail server(s) configured
                                        </p>
                                    </div>
                                    <div class="flex-shrink-0">
                                        <span class="text-xs font-mono px-2 py-1 rounded bg-emerald-100 dark:bg-emerald-900/30 text-emerald-700 dark:text-emerald-300">
                                            +10 pts
                                        </span>
                                    </div>
                                </div>

                                <!-- SPF -->
                                <div class="px-5 py-3 flex items-center gap-4">
                                    <div class="flex-shrink-0 w-8 text-center">
                                        <span v-if="emailHealthAnalysis.spf.present" class="mdi mdi-check-circle text-emerald-500"></span>
                                        <span v-else class="mdi mdi-close-circle text-red-400"></span>
                                    </div>
                                    <div class="flex-1 min-w-0">
                                        <div class="flex items-center gap-2">
                                            <span class="text-sm font-medium text-slate-700 dark:text-slate-300">SPF</span>
                                        </div>
                                        <p class="text-xs text-slate-500 dark:text-slate-400 mt-0.5">
                                            <span v-if="emailHealthAnalysis.spf.present">
                                                {{ emailHealthAnalysis.spf.details.join('  ') }}
                                            </span>
                                            <span v-else class="text-red-500 dark:text-red-400">No SPF record found</span>
                                        </p>
                                    </div>
                                    <div class="flex-shrink-0">
                                        <span class="text-xs font-mono px-2 py-1 rounded"
                                            :class="emailHealthAnalysis.spf.score === 25
                                                ? 'bg-emerald-100 dark:bg-emerald-900/30 text-emerald-700 dark:text-emerald-300'
                                                : emailHealthAnalysis.spf.score > 0
                                                    ? 'bg-amber-100 dark:bg-amber-900/30 text-amber-700 dark:text-amber-300'
                                                    : 'bg-red-100 dark:bg-red-900/30 text-red-700 dark:text-red-300'">
                                            +{{ emailHealthAnalysis.spf.score }}/25 pts
                                        </span>
                                    </div>
                                </div>

                                <!-- DKIM -->
                                <div class="px-5 py-3 flex items-center gap-4">
                                    <div class="flex-shrink-0 w-8 text-center">
                                        <span v-if="emailHealthAnalysis.dkim.present" class="mdi mdi-key text-cyan-500"></span>
                                        <span v-else class="mdi mdi-key-remove text-red-400"></span>
                                    </div>
                                    <div class="flex-1 min-w-0">
                                        <div class="flex items-center gap-2">
                                            <span class="text-sm font-medium text-slate-700 dark:text-slate-300">DKIM</span>
                                        </div>
                                        <p class="text-xs text-slate-500 dark:text-slate-400 mt-0.5">
                                            <span v-if="emailHealthAnalysis.dkim.present">
                                                Selectors: {{ emailHealthAnalysis.dkim.selectors.join(', ') }}
                                            </span>
                                            <span v-else class="text-red-500 dark:text-red-400">No DKIM records found</span>
                                        </p>
                                    </div>
                                    <div class="flex-shrink-0">
                                        <span class="text-xs font-mono px-2 py-1 rounded"
                                            :class="emailHealthAnalysis.dkim.score === 30
                                                ? 'bg-emerald-100 dark:bg-emerald-900/30 text-emerald-700 dark:text-emerald-300'
                                                : emailHealthAnalysis.dkim.score > 0
                                                    ? 'bg-amber-100 dark:bg-amber-900/30 text-amber-700 dark:text-amber-300'
                                                    : 'bg-red-100 dark:bg-red-900/30 text-red-700 dark:text-red-300'">
                                            +{{ emailHealthAnalysis.dkim.score }}/30 pts
                                        </span>
                                    </div>
                                </div>

                                <!-- DMARC -->
                                <div class="px-5 py-3 flex items-center gap-4">
                                    <div class="flex-shrink-0 w-8 text-center">
                                        <span v-if="emailHealthAnalysis.dmarc.present" class="mdi mdi-shield-check text-emerald-500"></span>
                                        <span v-else class="mdi mdi-shield-off text-red-400"></span>
                                    </div>
                                    <div class="flex-1 min-w-0">
                                        <div class="flex items-center gap-2">
                                            <span class="text-sm font-medium text-slate-700 dark:text-slate-300">DMARC</span>
                                        </div>
                                        <p class="text-xs text-slate-500 dark:text-slate-400 mt-0.5">
                                            <span v-if="emailHealthAnalysis.dmarc.present">
                                                {{ emailHealthAnalysis.dmarc.details.join('  ') }}
                                            </span>
                                            <span v-else class="text-red-500 dark:text-red-400">No DMARC record found</span>
                                        </p>
                                    </div>
                                    <div class="flex-shrink-0">
                                        <span class="text-xs font-mono px-2 py-1 rounded"
                                            :class="emailHealthAnalysis.dmarc.score === 35
                                                ? 'bg-emerald-100 dark:bg-emerald-900/30 text-emerald-700 dark:text-emerald-300'
                                                : emailHealthAnalysis.dmarc.score > 0
                                                    ? 'bg-amber-100 dark:bg-amber-900/30 text-amber-700 dark:text-amber-300'
                                                    : 'bg-red-100 dark:bg-red-900/30 text-red-700 dark:text-red-300'">
                                            +{{ emailHealthAnalysis.dmarc.score }}/35 pts
                                        </span>
                                    </div>
                                </div>
                            </div>

                            <!-- Recommendations -->
                            <div v-if="emailHealthAnalysis.recommendations.length > 0"
                                class="px-5 py-3 bg-amber-50 dark:bg-amber-900/20 border-t border-amber-100 dark:border-amber-900/30">
                                <div class="flex items-center gap-2 mb-2">
                                    <span class="mdi mdi-lightbulb text-amber-600 dark:text-amber-400"></span>
                                    <span class="text-xs font-semibold text-amber-700 dark:text-amber-300 uppercase tracking-wider">Recommendations</span>
                                </div>
                                <ul class="space-y-1">
                                    <li v-for="rec in emailHealthAnalysis.recommendations" :key="rec"
                                        class="text-sm text-amber-700 dark:text-amber-300 flex items-start gap-2">
                                        <span class="mdi mdi-chevron-right mt-0.5 flex-shrink-0"></span>
                                        <span>{{ rec }}</span>
                                    </li>
                                </ul>
                            </div>
                        </div>

                        <div
                            class="bg-white dark:bg-slate-900 rounded-xl shadow-sm border border-slate-200 dark:border-slate-800 overflow-hidden">
                            <div
                                class="px-5 py-4 border-b border-slate-100 dark:border-slate-800 bg-slate-50/50 dark:bg-slate-950/30">
                                <h3
                                    class="text-sm font-semibold text-slate-900 dark:text-cyan-50 uppercase tracking-wider">
                                    DNS Records</h3>
                            </div>
                            <div class="overflow-x-auto">
                                <table class="min-w-full divide-y divide-slate-200 dark:divide-slate-800">
                                    <thead class="bg-slate-50 dark:bg-slate-950/50">
                                        <tr>
                                            <th
                                                class="px-6 py-3 text-left text-xs font-medium text-slate-500 dark:text-slate-400 uppercase tracking-wider w-20">
                                                Type</th>
                                            <th
                                                class="px-6 py-3 text-left text-xs font-medium text-slate-500 dark:text-slate-400 uppercase tracking-wider w-32">
                                                Name</th>
                                            <th
                                                class="px-6 py-3 text-left text-xs font-medium text-slate-500 dark:text-slate-400 uppercase tracking-wider">
                                                Value</th>
                                        </tr>
                                    </thead>
                                    <tbody
                                        class="bg-white dark:bg-slate-900 divide-y divide-slate-200 dark:divide-slate-800">
                                        <tr v-for="record in sortedDnsRecords" class="hover:bg-slate-50 dark:hover:bg-slate-800/30 transition-colors">
                                            <td class="px-6 py-3 whitespace-nowrap text-xs font-bold text-slate-600 dark:text-slate-300 uppercase">{{ record.type }}</td>
                                            <td class="px-6 py-3 whitespace-nowrap text-xs text-slate-500 dark:text-slate-400 font-mono">{{ record.name }}</td>
                                            <td class="px-6 py-3 text-xs text-slate-800 dark:text-slate-300 font-mono break-all">
                                                <span @contextmenu.prevent="showContextMenu($event, record.value)">{{ record.value }}</span>
                                            </td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>

                        <div class="bg-slate-950 rounded-xl shadow-lg border border-slate-900 overflow-hidden relative group">
                            <div class="absolute top-4 right-4 flex gap-2 opacity-0 group-hover:opacity-100 transition-opacity z-10">
                                <button @click="copyZone()"
                                    class="p-2 bg-slate-800 hover:bg-slate-700 text-slate-300 rounded-md shadow-sm border border-slate-700 transition-colors"
                                    title="Copy">
                                    <span class="mdi mdi-content-copy"></span>
                                </button>
                                <button @click="downloadZone()"
                                    class="p-2 bg-slate-800 hover:bg-slate-700 text-slate-300 rounded-md shadow-sm border border-slate-700 transition-colors"
                                    title="Download">
                                    <span class="mdi mdi-download"></span>
                                </button>
                            </div>
                            <div class="px-5 py-3 bg-black/40 border-b border-slate-900 flex justify-between items-center">
                                <h3 class="text-xs font-semibold text-slate-400 uppercase tracking-wider">BIND Zone File
                                </h3>
                            </div>
                            <div class="p-0 overflow-x-auto custom-scroll bg-[#0b1016]">
                                <pre class="language-dns-zone-file !m-0 !bg-transparent !p-4 !text-sm"><code class="language-dns-zone-file">{{ response.zone }}</code></pre>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </main>

        <div v-if="contextMenu.show"
            class="fixed bg-white dark:bg-slate-800 rounded-lg shadow-xl border border-slate-200 dark:border-slate-700 py-1 z-50 w-48 animate-scale-in"
            :style="{ top: contextMenu.y + 'px', left: contextMenu.x + 'px' }" @mouseleave="contextMenu.show = false">
            <div v-if="isDomain(contextMenu.value)" @click="runDig(contextMenu.value)"
                class="px-4 py-2 text-sm text-slate-700 dark:text-slate-200 hover:bg-cyan-50 dark:hover:bg-slate-700 cursor-pointer flex items-center gap-2">
                <span class="mdi mdi-dns w-4"></span> Dig {{ contextMenu.value }}
            </div>
            <div v-if="isIp(contextMenu.value)" @click="viewWhois(contextMenu.value)"
                class="px-4 py-2 text-sm text-slate-700 dark:text-slate-200 hover:bg-cyan-50 dark:hover:bg-slate-700 cursor-pointer flex items-center gap-2">
                <span class="mdi mdi-card-account-details w-4"></span> View Whois {{ contextMenu.value }}
            </div>
            <div @click="copyToClipboard(contextMenu.value)"
                class="px-4 py-2 text-sm text-slate-700 dark:text-slate-200 hover:bg-cyan-50 dark:hover:bg-slate-700 cursor-pointer flex items-center gap-2 border-t border-slate-100 dark:border-slate-700 mt-1">
                <span class="mdi mdi-content-copy w-4"></span> Copy Value
            </div>
        </div>

        <div v-if="dialog.show" class="fixed inset-0 z-50 overflow-y-auto">
            <div class="flex items-end justify-center min-h-screen pt-4 px-4 pb-20 text-center sm:block sm:p-0">
                <div class="fixed inset-0 bg-slate-900/75 transition-opacity" @click="dialog.show = false"></div>
                <span class="hidden sm:inline-block sm:align-middle sm:h-screen">&#8203;</span>
                <div
                    class="inline-block align-bottom bg-white dark:bg-slate-900 rounded-xl text-left overflow-hidden shadow-xl transform transition-all sm:my-8 sm:align-middle sm:max-w-4xl sm:w-full border border-slate-200 dark:border-slate-800">
                    <div class="px-4 pt-5 pb-4 sm:p-6 sm:pb-4">
                        <div class="flex justify-between items-center mb-4">
                            <h3 class="text-lg leading-6 font-medium text-slate-900 dark:text-white">{{ dialog.title }}</h3>
                            <button @click="dialog.show = false" class="text-slate-400 hover:text-slate-500"><span class="mdi mdi-close text-xl"></span></button>
                        </div>
                        <div v-if="dialog.tabs" class="flex gap-1 relative z-10">
                            <button v-for="(content, tabName) in dialog.tabs" :key="tabName"
                                @click="dialog.activeTab = tabName"
                                class="px-4 py-2 text-sm font-medium rounded-t-lg border-t border-l border-r -mb-px"
                                :class="dialog.activeTab === tabName
                                    ? 'bg-slate-800 dark:bg-black/50 text-cyan-400 border-slate-700 border-b border-b-slate-800 dark:border-b-black/50'
                                    : 'text-slate-400 dark:text-slate-500 hover:text-slate-200 dark:hover:text-slate-300 hover:bg-slate-700/50 dark:hover:bg-slate-800/30 border-transparent'">
                                {{ tabName }}
                            </button>
                        </div>
                        <div
                            class="bg-slate-800 dark:bg-black/50 p-4 overflow-auto max-h-[70vh] custom-scroll border border-slate-700 dark:border-slate-700 relative"
                            :class="dialog.tabs ? 'rounded-b-lg rounded-tr-lg' : 'rounded-lg'">
                            <pre v-if="dialog.tabs && dialog.activeTab"
                                class="text-xs sm:text-sm text-cyan-50 font-mono whitespace-pre-wrap">{{ dialog.tabs[dialog.activeTab] }}</pre>
                            <pre v-else
                                class="text-xs sm:text-sm text-cyan-50 font-mono whitespace-pre-wrap">{{ dialog.content }}</pre>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div v-if="showHistoryModal" class="fixed inset-0 z-50 overflow-y-auto">
            <div class="flex items-center justify-center min-h-screen px-4 pt-4 pb-20 text-center sm:block sm:p-0">
                <div class="fixed inset-0 bg-slate-900/75 transition-opacity" @click="showHistoryModal = false"></div>
                <div
                    class="inline-block align-bottom bg-white dark:bg-slate-900 rounded-xl text-left overflow-hidden shadow-xl transform transition-all sm:my-8 sm:align-middle sm:max-w-xl sm:w-full border border-slate-200 dark:border-slate-700">
                    <div
                        class="px-6 py-4 border-b border-slate-200 dark:border-slate-700 flex justify-between items-center bg-slate-50 dark:bg-slate-950">
                        <h3 class="text-lg font-medium text-slate-900 dark:text-white">Scan Log</h3>
                        <div class="flex gap-2">
                            <button @click="exportHistory" :disabled="historyItems.length === 0"
                                class="p-2 text-slate-500 hover:text-cyan-600 dark:hover:text-cyan-400 disabled:opacity-30"><span
                                    class="mdi mdi-export-variant"></span></button>
                            <button @click="triggerImport"
                                class="p-2 text-slate-500 hover:text-cyan-600 dark:hover:text-cyan-400"><span
                                    class="mdi mdi-import"></span></button>
                            <button @click="showHistoryModal = false"
                                class="p-2 text-slate-500 hover:text-slate-700"><span
                                    class="mdi mdi-close"></span></button>
                        </div>
                    </div>
                    <div class="px-4 py-3 border-b border-slate-200 dark:border-slate-700 space-y-3">
                        <div class="relative">
                            <span class="mdi mdi-magnify absolute left-3 top-1/2 -translate-y-1/2 text-slate-400"></span>
                            <input v-model="historySearch" @input="searchHistory" type="text" ref="historySearchInput"
                                class="w-full pl-10 pr-4 py-2 text-sm bg-slate-100 dark:bg-slate-800 border-0 rounded-lg text-slate-900 dark:text-white placeholder-slate-400 focus:ring-2 focus:ring-cyan-500"
                                placeholder="Search domains...">
                        </div>
                        <div class="flex gap-2 flex-wrap">
                            <select v-model="historyFilters.existence" @change="applyHistoryFilters"
                                class="text-xs bg-slate-100 dark:bg-slate-800 border-0 rounded-lg text-slate-700 dark:text-slate-300 py-1.5 px-2 focus:ring-2 focus:ring-cyan-500">
                                <option value="all">All Domains</option>
                                <option value="exists">Exists</option>
                                <option value="nonexistent">Non-existent</option>
                            </select>
                            <select v-model="historyFilters.platform" @change="applyHistoryFilters"
                                class="text-xs bg-slate-100 dark:bg-slate-800 border-0 rounded-lg text-slate-700 dark:text-slate-300 py-1.5 px-2 focus:ring-2 focus:ring-cyan-500">
                                <option value="all">Any Platform</option>
                                <option v-for="platform in availablePlatforms" :key="platform" :value="platform">{{ platform }}</option>
                            </select>
                            <select v-model="historyFilters.scanCount" @change="applyHistoryFilters"
                                class="text-xs bg-slate-100 dark:bg-slate-800 border-0 rounded-lg text-slate-700 dark:text-slate-300 py-1.5 px-2 focus:ring-2 focus:ring-cyan-500">
                                <option value="all">Any # Scans</option>
                                <option v-for="opt in scanCountOptions" :key="opt.value" :value="opt.value">{{ opt.label }}</option>
                            </select>
                            <button v-if="historyFilters.existence !== 'all' || historyFilters.platform !== 'all' || historyFilters.scanCount !== 'all'"
                                @click="clearHistoryFilters"
                                class="text-xs text-slate-500 hover:text-cyan-600 dark:hover:text-cyan-400 py-1.5 px-2">
                                <span class="mdi mdi-close"></span> Clear
                            </button>
                        </div>
                    </div>
                    <div class="max-h-[50vh] overflow-y-auto custom-scroll">
                        <input type="file" ref="importFile" @change="importHistory" accept=".json" class="hidden" />
                        <ul v-if="historyItems.length > 0" class="divide-y divide-slate-200 dark:divide-slate-800">
                            <li v-for="(item, index) in historyItems" :key="item.id || index" :id="'history-item-' + index"
                                @click="loadFromHistory(item)"
                                class="px-6 py-4 cursor-pointer transition-colors group"
                                :class="{
                                    'bg-slate-100 dark:bg-slate-800 ring-inset ring-2 ring-cyan-500/50': index === selectedHistoryIndex,
                                    'hover:bg-slate-50 dark:hover:bg-slate-800': index !== selectedHistoryIndex
                                }">
                                <div class="flex justify-between items-center">
                                    <div>
                                        <p class="text-sm font-medium text-cyan-600 dark:text-cyan-400">{{ item.domain }}</p>
                                        <p class="text-xs text-slate-500 dark:text-slate-400">{{ new Date(item.timestamp * 1000).toLocaleString() }}</p>
                                    </div>
                                    <span class="mdi mdi-chevron-right text-slate-300 group-hover:text-slate-500"></span>
                                </div>
                            </li>
                        </ul>
                        <div v-else class="text-center py-12"><span
                                class="mdi mdi-history text-5xl text-slate-200 dark:text-slate-700"></span>
                            <p class="mt-2 text-slate-500">{{ historySearch || historyFilters.existence !== 'all' || historyFilters.platform !== 'all' || historyFilters.scanCount !== 'all' ? 'No matches found' : 'Log empty' }}</p>
                        </div>
                    </div>
                    <div v-if="historyItems.length > 0 && historyItems.length < historyTotal"
                        class="px-6 py-3 border-t border-slate-200 dark:border-slate-700 bg-slate-50 dark:bg-slate-950">
                        <button @click="loadMoreHistory"
                            class="w-full text-sm text-cyan-600 dark:text-cyan-400 hover:text-cyan-700 dark:hover:text-cyan-300 font-medium">
                            Load more ({{ historyItems.length }} of {{ historyTotal }})
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <div v-if="showVersionsModal" class="fixed inset-0 z-50 overflow-y-auto">
            <div class="flex items-center justify-center min-h-screen px-4 pt-4 pb-20 text-center sm:block sm:p-0">
                <div class="fixed inset-0 bg-slate-900/75 transition-opacity" @click="showVersionsModal = false"></div>
                <div
                    class="inline-block align-bottom bg-white dark:bg-slate-900 rounded-xl text-left overflow-hidden shadow-xl transform transition-all sm:my-8 sm:align-middle sm:max-w-xl sm:w-full border border-slate-200 dark:border-slate-700">
                    <div
                        class="px-6 py-4 border-b border-slate-200 dark:border-slate-700 flex justify-between items-center bg-slate-50 dark:bg-slate-950">
                        <h3 class="text-lg font-medium text-slate-900 dark:text-white">Snapshots: {{ domain }}</h3>
                        <button @click="showVersionsModal = false" class="text-slate-400 hover:text-slate-500"><span
                                class="mdi mdi-close"></span></button>
                    </div>
                    <ul class="divide-y divide-slate-200 dark:divide-slate-800 max-h-[60vh] overflow-y-auto custom-scroll">
                        <li v-for="(item, index) in domainVersions" :key="item.id" :id="'version-item-' + index"
                            @click="loadFromHistory(item)"
                            class="px-6 py-4 cursor-pointer transition-all flex justify-between items-center group border-l-4" :class="{
                                'bg-cyan-50 dark:bg-cyan-900/20 border-cyan-500': item.timestamp === response.timestamp,
                                'bg-slate-100 dark:bg-slate-800 ring-inset ring-2 ring-cyan-500/50 z-10': index === selectedIndex,
                                'hover:bg-slate-50 dark:hover:bg-slate-800 border-transparent': item.timestamp !== response.timestamp && index !== selectedIndex
                            }">
                    
                            <div class="flex items-center gap-3">
                                <span v-if="item.timestamp === response.timestamp" class="mdi mdi-check-circle text-cyan-500"></span>
                                <span v-else class="mdi mdi-clock-outline text-slate-400"></span>
                                <div>
                                    <p class="text-sm font-medium text-slate-900 dark:text-slate-200">
                                        {{ new Date(item.timestamp * 1000).toLocaleString() }}
                                    </p>
                                </div>
                            </div>
                            <button @click.stop="deleteHistoryItem(index, item)"
                                class="p-1 text-slate-400 hover:text-red-500 transition-colors opacity-0 group-hover:opacity-100"
                                :class="{'opacity-100': index === selectedIndex}">
                                <span class="mdi mdi-trash-can-outline"></span>
                            </button>
                        </li>
                    </ul>
                </div>
            </div>
        </div>

        <div v-if="showHelpModal" class="fixed inset-0 z-50 overflow-y-auto">
            <div class="flex items-center justify-center min-h-screen px-4 pt-4 pb-20 text-center sm:block sm:p-0">
                <div class="fixed inset-0 bg-slate-900/75 transition-opacity" @click="showHelpModal = false"></div>
                <div
                    class="inline-block align-bottom bg-white dark:bg-slate-900 rounded-xl text-left overflow-hidden shadow-xl transform transition-all sm:my-8 sm:align-middle sm:max-w-md sm:w-full border border-slate-200 dark:border-slate-700">
                    <div
                        class="px-6 py-4 border-b border-slate-200 dark:border-slate-700 flex justify-between items-center bg-slate-50 dark:bg-slate-950">
                        <h3 class="text-lg font-medium text-slate-900 dark:text-white">Help</h3>
                        <button @click="showHelpModal = false" class="text-slate-400 hover:text-slate-500"><span
                                class="mdi mdi-close"></span></button>
                    </div>
                    <div class="p-6">
                        <h4 class="text-sm font-semibold text-slate-900 dark:text-white uppercase tracking-wider mb-4">Keyboard Shortcuts</h4>
                        <div class="space-y-3">
                            <div class="flex justify-between items-center">
                                <span class="text-sm text-slate-600 dark:text-slate-400">Focus search</span>
                                <kbd class="px-2 py-1 text-xs font-mono bg-slate-100 dark:bg-slate-800 text-slate-700 dark:text-slate-300 rounded border border-slate-200 dark:border-slate-700">/</kbd>
                            </div>
                            <div class="flex justify-between items-center">
                                <span class="text-sm text-slate-600 dark:text-slate-400">Close modal</span>
                                <kbd class="px-2 py-1 text-xs font-mono bg-slate-100 dark:bg-slate-800 text-slate-700 dark:text-slate-300 rounded border border-slate-200 dark:border-slate-700">Esc</kbd>
                            </div>
                            <div class="flex justify-between items-center">
                                <span class="text-sm text-slate-600 dark:text-slate-400">Navigate lists</span>
                                <div class="flex gap-1">
                                    <kbd class="px-2 py-1 text-xs font-mono bg-slate-100 dark:bg-slate-800 text-slate-700 dark:text-slate-300 rounded border border-slate-200 dark:border-slate-700">&uarr;</kbd>
                                    <kbd class="px-2 py-1 text-xs font-mono bg-slate-100 dark:bg-slate-800 text-slate-700 dark:text-slate-300 rounded border border-slate-200 dark:border-slate-700">&darr;</kbd>
                                </div>
                            </div>
                            <div class="flex justify-between items-center">
                                <span class="text-sm text-slate-600 dark:text-slate-400">Select item</span>
                                <kbd class="px-2 py-1 text-xs font-mono bg-slate-100 dark:bg-slate-800 text-slate-700 dark:text-slate-300 rounded border border-slate-200 dark:border-slate-700">Enter</kbd>
                            </div>
                            <div class="flex justify-between items-center">
                                <span class="text-sm text-slate-600 dark:text-slate-400">Show help</span>
                                <kbd class="px-2 py-1 text-xs font-mono bg-slate-100 dark:bg-slate-800 text-slate-700 dark:text-slate-300 rounded border border-slate-200 dark:border-slate-700">?</kbd>
                            </div>
                            <div class="flex justify-between items-center">
                                <span class="text-sm text-slate-600 dark:text-slate-400">Scan log</span>
                                <div class="flex gap-1">
                                    <kbd class="px-2 py-1 text-xs font-mono bg-slate-100 dark:bg-slate-800 text-slate-700 dark:text-slate-300 rounded border border-slate-200 dark:border-slate-700"></kbd>
                                    <kbd class="px-2 py-1 text-xs font-mono bg-slate-100 dark:bg-slate-800 text-slate-700 dark:text-slate-300 rounded border border-slate-200 dark:border-slate-700">K</kbd>
                                </div>
                            </div>
                        </div>
                        <div v-if="localMode" class="mt-6 pt-4 border-t border-slate-200 dark:border-slate-700">
                            <h4 class="text-sm font-semibold text-slate-900 dark:text-white uppercase tracking-wider mb-4">CLI Usage</h4>
                            <div class="space-y-3 text-sm">
                                <div>
                                    <p class="text-slate-500 dark:text-slate-400 mb-1">Scan a domain</p>
                                    <code class="block bg-slate-100 dark:bg-slate-800 px-3 py-2 rounded font-mono text-xs text-slate-700 dark:text-slate-300">php ~/.periscope/engine.php example.com</code>
                                </div>
                                <div>
                                    <p class="text-slate-500 dark:text-slate-400 mb-1">Start local server</p>
                                    <code class="block bg-slate-100 dark:bg-slate-800 px-3 py-2 rounded font-mono text-xs text-slate-700 dark:text-slate-300">curl -sL https://periscope.run/boot.sh | bash</code>
                                </div>
                                <div>
                                    <p class="text-slate-500 dark:text-slate-400 mb-1">Use local UI during development</p>
                                    <code class="block bg-slate-100 dark:bg-slate-800 px-3 py-2 rounded font-mono text-xs text-slate-700 dark:text-slate-300">./boot.sh --local</code>
                                </div>
                            </div>
                        </div>
                        <div v-if="bridgeHasDb" class="mt-6 pt-4 border-t border-slate-200 dark:border-slate-700">
                            <h4 class="text-sm font-semibold text-slate-900 dark:text-white uppercase tracking-wider mb-4">Database</h4>
                            <div class="space-y-2 text-sm">
                                <div class="flex justify-between items-start gap-4">
                                    <span class="text-slate-500 dark:text-slate-400">Path</span>
                                    <span class="font-mono text-slate-700 dark:text-slate-300 text-right text-xs break-all">{{ dbInfo.path }}</span>
                                </div>
                                <div class="flex justify-between items-center">
                                    <span class="text-slate-500 dark:text-slate-400">Size</span>
                                    <span class="font-mono text-slate-700 dark:text-slate-300">{{ formatBytes(dbInfo.size) }}</span>
                                </div>
                                <div class="flex justify-between items-center">
                                    <span class="text-slate-500 dark:text-slate-400">Stored Scans</span>
                                    <span class="font-mono text-slate-700 dark:text-slate-300">{{ dbInfo.scanCount.toLocaleString() }}</span>
                                </div>
                            </div>
                        </div>
                        <div v-if="localMode && scansInfo.path" class="mt-6 pt-4 border-t border-slate-200 dark:border-slate-700">
                            <h4 class="text-sm font-semibold text-slate-900 dark:text-white uppercase tracking-wider mb-4">Raw Data</h4>
                            <div class="space-y-2 text-sm">
                                <div class="flex justify-between items-start gap-4">
                                    <span class="text-slate-500 dark:text-slate-400">Path</span>
                                    <span class="font-mono text-slate-700 dark:text-slate-300 text-right text-xs break-all">{{ scansInfo.path }}</span>
                                </div>
                                <div class="flex justify-between items-center">
                                    <span class="text-slate-500 dark:text-slate-400">Storage</span>
                                    <span class="font-mono text-slate-700 dark:text-slate-300">{{ formatBytes(scansInfo.size) }}</span>
                                </div>
                            </div>
                        </div>
                        <div class="mt-6 pt-4 border-t border-slate-200 dark:border-slate-700">
                            <a href="https://github.com/austinginder/periscope/releases" target="_blank"
                                class="inline-flex items-center text-sm text-cyan-600 dark:text-cyan-400 hover:underline">
                                <span class="mdi mdi-tag-outline mr-1"></span>
                                Version {{ version }}
                            </a>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Open Graph Preview Modal -->
        <div v-if="showOgPreview && response.metadata && response.metadata.meta_tags && response.metadata.meta_tags.open_graph" class="fixed inset-0 z-50 overflow-y-auto">
            <div class="flex items-center justify-center min-h-screen px-4 pt-4 pb-20 text-center sm:block sm:p-0">
                <div class="fixed inset-0 bg-slate-900/75 transition-opacity" @click="showOgPreview = false"></div>
                <div class="inline-block align-bottom bg-white dark:bg-slate-900 rounded-xl text-left overflow-hidden shadow-xl transform transition-all sm:my-8 sm:align-middle sm:max-w-lg sm:w-full border border-slate-200 dark:border-slate-700">
                    <div class="px-6 py-4 border-b border-slate-200 dark:border-slate-700 flex justify-between items-center bg-slate-50 dark:bg-slate-950">
                        <h3 class="text-lg font-medium text-slate-900 dark:text-white">Open Graph Preview</h3>
                        <button @click="showOgPreview = false" class="text-slate-400 hover:text-slate-500"><span class="mdi mdi-close"></span></button>
                    </div>
                    <div class="p-6">
                        <!-- Social Card Preview -->
                        <div class="border border-slate-200 dark:border-slate-700 rounded-lg overflow-hidden bg-white dark:bg-slate-800 shadow-sm">
                            <!-- OG Image -->
                            <div v-if="response.metadata.meta_tags.open_graph.image" class="aspect-[1.91/1] bg-slate-100 dark:bg-slate-900 overflow-hidden">
                                <img :src="response.metadata.meta_tags.open_graph.image_hash ? getUrl(`action=get_file&domain=${encodeURIComponent(domain)}&hash=${response.metadata.meta_tags.open_graph.image_hash}&extension=${response.metadata.meta_tags.open_graph.image_extension}`) : response.metadata.meta_tags.open_graph.image"
                                     :alt="response.metadata.meta_tags.open_graph.title || 'Preview'"
                                     class="w-full h-full object-cover"
                                     @error="$event.target.parentElement.innerHTML = '<div class=\'flex items-center justify-center h-full text-slate-400\'><span class=\'mdi mdi-image-off text-4xl\'></span></div>'">
                            </div>
                            <div v-else class="aspect-[1.91/1] bg-slate-100 dark:bg-slate-900 flex items-center justify-center">
                                <span class="mdi mdi-image-off text-4xl text-slate-300 dark:text-slate-600"></span>
                            </div>
                            <!-- OG Content -->
                            <div class="p-4">
                                <p class="text-xs text-slate-500 dark:text-slate-400 uppercase tracking-wide mb-1">{{ domain }}</p>
                                <h4 class="font-semibold text-slate-900 dark:text-white text-base leading-tight mb-1">
                                    {{ response.metadata.meta_tags.open_graph.title || response.metadata.meta_tags.basic?.title || 'No title' }}
                                </h4>
                                <p v-if="response.metadata.meta_tags.open_graph.description" class="text-sm text-slate-600 dark:text-slate-400 line-clamp-2">
                                    {{ response.metadata.meta_tags.open_graph.description }}
                                </p>
                            </div>
                        </div>
                        <!-- OG Data Details -->
                        <div class="mt-4 space-y-2 text-xs">
                            <div v-if="response.metadata.meta_tags.open_graph.type" class="flex justify-between">
                                <span class="text-slate-500 dark:text-slate-400">og:type</span>
                                <span class="font-mono text-slate-700 dark:text-slate-300">{{ response.metadata.meta_tags.open_graph.type }}</span>
                            </div>
                            <div v-if="response.metadata.meta_tags.open_graph.image" class="flex justify-between gap-2">
                                <span class="text-slate-500 dark:text-slate-400 shrink-0">og:image</span>
                                <span class="font-mono text-slate-700 dark:text-slate-300 truncate text-right">{{ response.metadata.meta_tags.open_graph.image }}</span>
                            </div>
                            <div v-if="response.metadata.meta_tags.open_graph.image_hash" class="flex justify-between gap-2">
                                <span class="text-slate-500 dark:text-slate-400 shrink-0">Stored</span>
                                <span class="font-mono text-slate-700 dark:text-slate-300">{{ response.metadata.meta_tags.open_graph.image_extension?.toUpperCase() }}  {{ formatBytes(response.metadata.meta_tags.open_graph.image_size) }}</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Twitter Card Preview Modal -->
        <div v-if="showTwitterPreview && response.metadata && response.metadata.meta_tags && response.metadata.meta_tags.twitter" class="fixed inset-0 z-50 overflow-y-auto">
            <div class="flex items-center justify-center min-h-screen px-4 pt-4 pb-20 text-center sm:block sm:p-0">
                <div class="fixed inset-0 bg-slate-900/75 transition-opacity" @click="showTwitterPreview = false"></div>
                <div class="inline-block align-bottom bg-white dark:bg-slate-900 rounded-xl text-left overflow-hidden shadow-xl transform transition-all sm:my-8 sm:align-middle sm:max-w-lg sm:w-full border border-slate-200 dark:border-slate-700">
                    <div class="px-6 py-4 border-b border-slate-200 dark:border-slate-700 flex justify-between items-center bg-slate-50 dark:bg-slate-950">
                        <h3 class="text-lg font-medium text-slate-900 dark:text-white">Twitter Card Preview</h3>
                        <button @click="showTwitterPreview = false" class="text-slate-400 hover:text-slate-500"><span class="mdi mdi-close"></span></button>
                    </div>
                    <div class="p-6">
                        <!-- Twitter Card Preview -->
                        <div class="border border-slate-200 dark:border-slate-700 rounded-2xl overflow-hidden bg-white dark:bg-slate-800 shadow-sm">
                            <!-- Twitter Image (uses OG image as fallback) -->
                            <div v-if="response.metadata.meta_tags.twitter?.image || response.metadata.meta_tags.open_graph?.image" class="aspect-[1.91/1] bg-slate-100 dark:bg-slate-900 overflow-hidden">
                                <img :src="response.metadata.meta_tags.twitter?.image_hash ? getUrl(`action=get_file&domain=${encodeURIComponent(domain)}&hash=${response.metadata.meta_tags.twitter.image_hash}&extension=${response.metadata.meta_tags.twitter.image_extension}`) : (response.metadata.meta_tags.open_graph?.image_hash ? getUrl(`action=get_file&domain=${encodeURIComponent(domain)}&hash=${response.metadata.meta_tags.open_graph.image_hash}&extension=${response.metadata.meta_tags.open_graph.image_extension}`) : (response.metadata.meta_tags.twitter?.image || response.metadata.meta_tags.open_graph?.image))"
                                     :alt="response.metadata.meta_tags.twitter.title || 'Preview'"
                                     class="w-full h-full object-cover"
                                     @error="$event.target.parentElement.innerHTML = '<div class=\'flex items-center justify-center h-full text-slate-400\'><span class=\'mdi mdi-image-off text-4xl\'></span></div>'">
                            </div>
                            <div v-else class="aspect-[1.91/1] bg-slate-100 dark:bg-slate-900 flex items-center justify-center">
                                <span class="mdi mdi-image-off text-4xl text-slate-300 dark:text-slate-600"></span>
                            </div>
                            <!-- Twitter Content -->
                            <div class="p-3">
                                <p class="text-xs text-slate-500 dark:text-slate-400 mb-0.5">{{ domain }}</p>
                                <h4 class="font-normal text-slate-900 dark:text-white text-sm leading-tight">
                                    {{ response.metadata.meta_tags.twitter.title || response.metadata.meta_tags.open_graph?.title || response.metadata.meta_tags.basic?.title || 'No title' }}
                                </h4>
                            </div>
                        </div>
                        <!-- Twitter Data Details -->
                        <div class="mt-4 space-y-2 text-xs">
                            <div v-if="response.metadata.meta_tags.twitter.card" class="flex justify-between">
                                <span class="text-slate-500 dark:text-slate-400">twitter:card</span>
                                <span class="font-mono text-slate-700 dark:text-slate-300">{{ response.metadata.meta_tags.twitter.card }}</span>
                            </div>
                            <div v-if="response.metadata.meta_tags.twitter.site" class="flex justify-between">
                                <span class="text-slate-500 dark:text-slate-400">twitter:site</span>
                                <span class="font-mono text-slate-700 dark:text-slate-300">{{ response.metadata.meta_tags.twitter.site }}</span>
                            </div>
                            <div v-if="response.metadata.meta_tags.twitter?.image_hash" class="flex justify-between gap-2">
                                <span class="text-slate-500 dark:text-slate-400 shrink-0">Stored</span>
                                <span class="font-mono text-slate-700 dark:text-slate-300">{{ response.metadata.meta_tags.twitter.image_extension?.toUpperCase() }}  {{ formatBytes(response.metadata.meta_tags.twitter.image_size) }}</span>
                            </div>
                            <div v-else-if="response.metadata.meta_tags.open_graph?.image_hash" class="flex justify-between gap-2">
                                <span class="text-slate-500 dark:text-slate-400 shrink-0">Stored (from OG)</span>
                                <span class="font-mono text-slate-700 dark:text-slate-300">{{ response.metadata.meta_tags.open_graph.image_extension?.toUpperCase() }}  {{ formatBytes(response.metadata.meta_tags.open_graph.image_size) }}</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Favicon Preview Modal -->
        <div v-if="showFaviconPreview && response.metadata && response.metadata.favicon && response.metadata.favicon.present" class="fixed inset-0 z-50 overflow-y-auto">
            <div class="flex items-center justify-center min-h-screen px-4 pt-4 pb-20 text-center sm:block sm:p-0">
                <div class="fixed inset-0 bg-slate-900/75 transition-opacity" @click="showFaviconPreview = false"></div>
                <div class="inline-block align-bottom bg-white dark:bg-slate-900 rounded-xl text-left overflow-hidden shadow-xl transform transition-all sm:my-8 sm:align-middle sm:max-w-sm sm:w-full border border-slate-200 dark:border-slate-700">
                    <div class="px-6 py-4 border-b border-slate-200 dark:border-slate-700 flex justify-between items-center bg-slate-50 dark:bg-slate-950">
                        <h3 class="text-lg font-medium text-slate-900 dark:text-white">Favicon Preview</h3>
                        <button @click="showFaviconPreview = false" class="text-slate-400 hover:text-slate-500"><span class="mdi mdi-close"></span></button>
                    </div>
                    <div class="p-6">
                        <div class="flex flex-col items-center gap-4">
                            <!-- Favicon at multiple sizes -->
                            <div class="flex items-end gap-6">
                                <div class="text-center">
                                    <img :src="response.metadata.favicon.hash && response.metadata.favicon.extension ? getUrl(`action=get_file&domain=${encodeURIComponent(domain)}&hash=${response.metadata.favicon.hash}&extension=${response.metadata.favicon.extension}`) : getUrl(`action=get_raw&domain=${encodeURIComponent(domain)}&timestamp=${response.timestamp}&type=favicon`)"
                                         alt="Favicon" class="w-4 h-4 mx-auto mb-1"
                                         @error="$event.target.style.display='none'">
                                    <span class="text-xs text-slate-500">16px</span>
                                </div>
                                <div class="text-center">
                                    <img :src="response.metadata.favicon.hash && response.metadata.favicon.extension ? getUrl(`action=get_file&domain=${encodeURIComponent(domain)}&hash=${response.metadata.favicon.hash}&extension=${response.metadata.favicon.extension}`) : getUrl(`action=get_raw&domain=${encodeURIComponent(domain)}&timestamp=${response.timestamp}&type=favicon`)"
                                         alt="Favicon" class="w-8 h-8 mx-auto mb-1"
                                         @error="$event.target.style.display='none'">
                                    <span class="text-xs text-slate-500">32px</span>
                                </div>
                                <div class="text-center">
                                    <img :src="response.metadata.favicon.hash && response.metadata.favicon.extension ? getUrl(`action=get_file&domain=${encodeURIComponent(domain)}&hash=${response.metadata.favicon.hash}&extension=${response.metadata.favicon.extension}`) : getUrl(`action=get_raw&domain=${encodeURIComponent(domain)}&timestamp=${response.timestamp}&type=favicon`)"
                                         alt="Favicon" class="w-16 h-16 mx-auto mb-1"
                                         @error="$event.target.style.display='none'">
                                    <span class="text-xs text-slate-500">64px</span>
                                </div>
                            </div>
                            <!-- Favicon details -->
                            <div class="w-full mt-4 space-y-2 text-xs border-t border-slate-200 dark:border-slate-700 pt-4">
                                <div v-if="response.metadata.favicon.source" class="flex justify-between">
                                    <span class="text-slate-500 dark:text-slate-400">Source</span>
                                    <span class="font-mono text-slate-700 dark:text-slate-300">{{ response.metadata.favicon.source }}</span>
                                </div>
                                <div v-if="response.metadata.favicon.extension" class="flex justify-between">
                                    <span class="text-slate-500 dark:text-slate-400">Format</span>
                                    <span class="font-mono text-slate-700 dark:text-slate-300 uppercase">{{ response.metadata.favicon.extension }}</span>
                                </div>
                                <div v-if="response.metadata.favicon.hash" class="flex justify-between">
                                    <span class="text-slate-500 dark:text-slate-400">MD5 Hash</span>
                                    <span class="font-mono text-slate-700 dark:text-slate-300">{{ response.metadata.favicon.hash }}</span>
                                </div>
                                <div v-if="response.metadata.favicon.size" class="flex justify-between">
                                    <span class="text-slate-500 dark:text-slate-400">Size</span>
                                    <span class="font-mono text-slate-700 dark:text-slate-300">{{ formatBytes(response.metadata.favicon.size) }}</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- WordPress Plugins Modal -->
        <div v-if="showPluginsModal && response.cms && response.cms.plugins && response.cms.plugins.length > 0" class="fixed inset-0 z-50 overflow-y-auto">
            <div class="flex items-center justify-center min-h-screen px-4 pt-4 pb-20 text-center sm:block sm:p-0">
                <div class="fixed inset-0 bg-slate-900/75 transition-opacity" @click="showPluginsModal = false"></div>
                <div class="inline-block align-bottom bg-white dark:bg-slate-900 rounded-xl text-left overflow-hidden shadow-xl transform transition-all sm:my-8 sm:align-middle sm:max-w-md sm:w-full border border-slate-200 dark:border-slate-700">
                    <div class="px-6 py-4 border-b border-slate-200 dark:border-slate-700 flex justify-between items-center bg-slate-50 dark:bg-slate-950">
                        <h3 class="text-lg font-medium text-slate-900 dark:text-white flex items-center gap-2">
                            <span class="mdi mdi-puzzle-outline text-cyan-600 dark:text-cyan-400"></span>
                            WordPress Plugins
                        </h3>
                        <button @click="showPluginsModal = false" class="text-slate-400 hover:text-slate-500"><span class="mdi mdi-close"></span></button>
                    </div>
                    <div class="p-4 max-h-[60vh] overflow-y-auto custom-scroll">
                        <p class="text-xs text-slate-500 dark:text-slate-400 mb-3">{{ response.cms.plugins.length }} plugin{{ response.cms.plugins.length !== 1 ? 's' : '' }} detected from HTML source</p>
                        <ul class="space-y-2">
                            <li v-for="plugin in response.cms.plugins" :key="plugin" class="flex items-center gap-3 p-2 rounded-lg bg-slate-50 dark:bg-slate-800/50 hover:bg-slate-100 dark:hover:bg-slate-800 transition-colors">
                                <span class="mdi mdi-puzzle text-slate-400 dark:text-slate-500"></span>
                                <div class="flex-1 min-w-0">
                                    <p class="text-sm font-medium text-slate-900 dark:text-slate-200 truncate" :title="getPluginName(plugin) || plugin">
                                        {{ getPluginName(plugin) || plugin }}
                                    </p>
                                    <p v-if="getPluginName(plugin)" class="text-xs text-slate-500 dark:text-slate-400 font-mono truncate">{{ plugin }}</p>
                                </div>
                            </li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>

        <div v-if="snackbar.show" class="fixed bottom-4 right-4 z-50 animate-slide-in-right">
            <div
                class="bg-slate-800 dark:bg-cyan-500 text-white dark:text-slate-900 px-6 py-3 rounded-lg shadow-lg flex items-center gap-4 font-medium">
                <span>{{ snackbar.message }}</span>
                <button @click="snackbar.show = false"
                    class="text-sm font-bold opacity-75 hover:opacity-100">DISMISS</button>
            </div>
        </div>

    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/prism.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-dns-zone-file.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/vue@v3.5.19/dist/vue.global.js"></script>

    <script>
        const { createApp } = Vue;
        createApp({
            data() {
                return {
                    domain: "",
                    loading: false,
                    loadingText: "Scanning...",
                    loadingFromHistory: false,
                    progress: { step: 0, total: 7, percent: 0, message: '' },
                    localMode: false,
                    bridgeConnected: null,
                    bridgeHasDb: false,
                    dbInfo: { path: '', size: 0, scanCount: 0 },
                    scansInfo: { path: '', size: 0 },
                    serverVersion: null,
                    response: { domain: "", errors: [], zone: "", timestamp: null, ip_lookup: {} },
                    currentTheme: localStorage.getItem('theme') || (document.documentElement.classList.contains('dark') ? 'dark' : 'light'),
                    showHistoryModal: false, historyItems: [], historyTotal: 0, historySearch: '', showVersionsModal: false, domainVersions: [], showAutocomplete: false,
                    historyFilters: { existence: 'all', platform: 'all', scanCount: 'all' },
                    availablePlatforms: [],
                    scanCountOptions: [],
                    snackbar: { show: false, message: "" },
                    contextMenu: { show: false, x: 0, y: 0, value: '' },
                    dialog: { show: false, title: '', content: '', tabs: null, activeTab: null },
                    selectedIndex: -1,
                    selectedHistoryIndex: -1,
                    showHelpModal: false,
                    showOgPreview: false,
                    showTwitterPreview: false,
                    showFaviconPreview: false,
                    showMissingMetadata: false,
                    showPluginsModal: false,
                    version: '1.3',
                    pendingDeepLink: null,
                }
            },
            watch: {
                showVersionsModal(val) {
                    if (val) {
                        // Find index of currently displayed scan
                        this.selectedIndex = this.domainVersions.findIndex(v => v.timestamp === this.response.timestamp);
                        if (this.selectedIndex === -1) this.selectedIndex = 0;
                        this.$nextTick(() => this.scrollToSelected());
                    }
                },
                showHistoryModal(val) {
                    if (val) {
                        this.selectedHistoryIndex = -1;
                        this.historySearch = '';
                        this.historyFilters = { existence: 'all', platform: 'all', scanCount: 'all' };
                        this.loadHistory();
                        this.loadAvailablePlatforms();
                        this.loadScanCountOptions();
                        this.$nextTick(() => {
                            if (this.$refs.historySearchInput) this.$refs.historySearchInput.focus();
                        });
                    }
                }
            },
            computed: {
                sortedDnsRecords() {
                    if (!this.response.dns_records) return [];
                    return [...this.response.dns_records].sort((a, b) => {
                        const typeDiff = a.type.localeCompare(b.type);
                        if (typeDiff !== 0) return typeDiff;
                        const nameDiff = a.name.localeCompare(b.name);
                        if (nameDiff !== 0) return nameDiff;
                        return a.value.localeCompare(b.value);
                    });
                },
                missingMetadataCount() {
                    if (!this.response.metadata) return 0;
                    const m = this.response.metadata;
                    let count = 0;
                    if (!m.robots_txt?.present) count++;
                    if (!m.sitemap?.present) count++;
                    if (!m.security_txt?.present) count++;
                    if (!m.ads_txt?.present) count++;
                    if (!m.app_ads_txt?.present) count++;
                    if (!m.app_site_association?.present) count++;
                    if (!m.assetlinks?.present) count++;
                    if (!m.manifest?.present) count++;
                    if (!m.webfinger?.present) count++;
                    if (!m.change_password?.present) count++;
                    if (!m.humans_txt?.present) count++;
                    if (!m.browserconfig?.present) count++;
                    if (!m.keybase_txt?.present) count++;
                    if (!m.meta_tags?.open_graph) count++;
                    if (!m.meta_tags?.twitter) count++;
                    if (!m.favicon?.present) count++;
                    return count;
                },
                otherVersions() {
                    if (!this.response.timestamp) return [];
                    return this.domainVersions.filter(v => v.timestamp != this.response.timestamp);
                },
                filteredHistory() {
                    if (!this.domain || this.domain.length < 1) return [];
                    const unique = []; const seen = new Set();
                    const sorted = [...this.historyItems].sort((a, b) => b.timestamp - a.timestamp);
                    for (const item of sorted) {
                        if (item.domain.toLowerCase().includes(this.domain.toLowerCase()) && !seen.has(item.domain)) {
                            unique.push(item); seen.add(item.domain);
                        }
                        if (unique.length >= 8) break;
                    }
                    return unique;
                },
                activeFilterCount() {
                    let count = 0;
                    if (this.historyFilters.existence !== 'all') count++;
                    if (this.historyFilters.platform !== 'all') count++;
                    if (this.historyFilters.scanCount !== 'all') count++;
                    return count;
                },
                isCrossDomainRedirect() {
                    if (!this.response.redirect_chain || this.response.redirect_chain.length < 2) return false;
                    const first = this.response.redirect_chain[0];
                    const last = this.response.redirect_chain[this.response.redirect_chain.length - 1];
                    try {
                        const firstHost = new URL(first.url).hostname.replace(/^www\./, '');
                        const lastHost = new URL(last.url).hostname.replace(/^www\./, '');
                        // Extract root domain (last two parts) for comparison
                        const getRoot = (h) => h.split('.').slice(-2).join('.');
                        return getRoot(firstHost) !== getRoot(lastHost);
                    } catch { return false; }
                },
                spfAnalysis() {
                    if (!this.response.dns_records) return null;
                    
                    // Find SPF record (TXT record starting with v=spf1, may be wrapped in quotes)
                    const spfRecord = this.response.dns_records.find(r => {
                        if (r.type !== 'TXT') return false;
                        const val = r.value.replace(/^["']|["']$/g, '').trim();
                        return val.toLowerCase().startsWith('v=spf1');
                    });
                    
                    if (!spfRecord) return null;
                    
                    // Strip surrounding quotes from the value
                    const raw = spfRecord.value.replace(/^["']|["']$/g, '').trim();
                    const parts = raw.split(/\s+/);
                    const mechanisms = [];
                    const errors = [];
                    const warnings = [];
                    let dnsLookups = 0;
                    let hasAll = false;
                    let allQualifier = '';
                    
                    // Known providers for include: mechanisms
                    const knownProviders = {
                        '_spf.google.com': 'Google Workspace',
                        'googlemail.com': 'Google Workspace',
                        '_spf.salesforce.com': 'Salesforce',
                        'sendgrid.net': 'SendGrid',
                        'spf.protection.outlook.com': 'Microsoft 365',
                        'amazonses.com': 'Amazon SES',
                        'servers.mcsv.net': 'Mailchimp',
                        'mailchimp.com': 'Mailchimp',
                        'spf.mailjet.com': 'Mailjet',
                        'mail.zendesk.com': 'Zendesk',
                        'helpscoutemail.com': 'Help Scout',
                        'freshdesk.com': 'Freshdesk',
                        'hubspot.com': 'HubSpot',
                        'intercom.io': 'Intercom',
                        'aspmx.pardot.com': 'Pardot',
                        'mktomail.com': 'Marketo',
                        'spf.constantcontact.com': 'Constant Contact',
                        'postmarkapp.com': 'Postmark',
                        'mailgun.org': 'Mailgun',
                        'email.freshservice.com': 'Freshservice',
                        'spf.mandrillapp.com': 'Mandrill',
                        'zoho.com': 'Zoho',
                        'smtp.com': 'SMTP.com',
                        'bluehost.com': 'Bluehost',
                        'godaddy.com': 'GoDaddy',
                        'hostgator.com': 'HostGator',
                        'secureserver.net': 'GoDaddy',
                        'wix.com': 'Wix',
                        'squarespace.com': 'Squarespace',
                        'shopify.com': 'Shopify',
                        'emailsrvr.com': 'Rackspace',
                        'brevo.com': 'Brevo',
                        'sendinblue.com': 'Brevo',
                        'klaviyo.com': 'Klaviyo',
                        'cmail20.com': 'Campaign Monitor',
                        'createsend.com': 'Campaign Monitor'
                    };
                    
                    // Mechanisms that require DNS lookups
                    const dnsLookupMechanisms = ['include', 'a', 'mx', 'ptr', 'exists', 'redirect'];
                    
                    for (const part of parts) {
                        if (part.toLowerCase() === 'v=spf1') {
                            mechanisms.push({ type: 'version', raw: part, description: 'SPF version identifier' });
                            continue;
                        }
                        
                        // Parse qualifier
                        let qualifier = '+'; // default pass
                        let mechanism = part;
                        if (/^[+\-~?]/.test(part)) {
                            qualifier = part[0];
                            mechanism = part.slice(1);
                        }
                        
                        const qualifierDesc = { '+': 'Pass', '-': 'Fail', '~': 'SoftFail', '?': 'Neutral' };
                        
                        // Parse mechanism type and value
                        const [mechType, ...valueParts] = mechanism.split(':');
                        const value = valueParts.join(':');
                        const lowerType = mechType.toLowerCase();
                        
                        let description = '';
                        let provider = null;
                        let isDnsLookup = false;
                        
                        switch (lowerType) {
                            case 'all':
                                hasAll = true;
                                allQualifier = qualifier;
                                description = qualifier === '-' ? 'Reject all other senders' :
                                              qualifier === '~' ? 'Soft-fail all other senders' :
                                              qualifier === '?' ? 'Neutral on all other senders' :
                                              'Allow all senders (not recommended)';
                                break;
                            case 'include':
                                isDnsLookup = true;
                                dnsLookups++;
                                // Check for known provider
                                for (const [domain, name] of Object.entries(knownProviders)) {
                                    if (value.includes(domain)) {
                                        provider = name;
                                        break;
                                    }
                                }
                                description = provider ? `Include ${provider} SPF` : `Include SPF from ${value}`;
                                break;
                            case 'ip4':
                                description = `Allow IPv4: ${value}`;
                                break;
                            case 'ip6':
                                description = `Allow IPv6: ${value}`;
                                break;
                            case 'a':
                                isDnsLookup = true;
                                dnsLookups++;
                                description = value ? `Allow A record of ${value}` : 'Allow domain A record';
                                break;
                            case 'mx':
                                isDnsLookup = true;
                                dnsLookups++;
                                description = value ? `Allow MX servers of ${value}` : 'Allow domain MX servers';
                                break;
                            case 'ptr':
                                isDnsLookup = true;
                                dnsLookups++;
                                warnings.push('PTR mechanism is deprecated and slow');
                                description = 'Validate via reverse DNS (deprecated)';
                                break;
                            case 'exists':
                                isDnsLookup = true;
                                dnsLookups++;
                                description = `Check if ${value} exists`;
                                break;
                            case 'redirect':
                                isDnsLookup = true;
                                dnsLookups++;
                                description = `Redirect to ${value} SPF policy`;
                                break;
                            case 'exp':
                                description = `Explanation domain: ${value}`;
                                break;
                            default:
                                if (part.includes('=')) {
                                    description = 'Modifier';
                                } else {
                                    errors.push(`Unknown mechanism: ${part}`);
                                    description = 'Unknown';
                                }
                        }
                        
                        mechanisms.push({
                            type: lowerType,
                            raw: part,
                            qualifier,
                            qualifierDesc: qualifierDesc[qualifier],
                            value,
                            description,
                            provider,
                            isDnsLookup
                        });
                    }
                    
                    // Validation checks
                    if (!parts[0]?.toLowerCase().startsWith('v=spf1')) {
                        errors.push('SPF record must start with v=spf1');
                    }
                    
                    if (!hasAll) {
                        warnings.push('Missing "all" mechanism - record should end with -all, ~all, or ?all');
                    } else if (allQualifier === '+') {
                        errors.push('+all allows anyone to send email as your domain');
                    }
                    
                    if (dnsLookups > 10) {
                        errors.push(`Too many DNS lookups (${dnsLookups}/10) - SPF will fail`);
                    } else if (dnsLookups > 8) {
                        warnings.push(`High DNS lookup count (${dnsLookups}/10) - close to limit`);
                    }
                    
                    if (raw.length > 255) {
                        warnings.push(`Record length (${raw.length} chars) exceeds 255 - requires multiple strings`);
                    }
                    
                    // Check for duplicates
                    const seen = new Set();
                    for (const m of mechanisms) {
                        if (m.type === 'include' && m.value) {
                            if (seen.has(m.value)) {
                                warnings.push(`Duplicate include: ${m.value}`);
                            }
                            seen.add(m.value);
                        }
                    }
                    
                    return {
                        raw,
                        mechanisms,
                        dnsLookups,
                        errors,
                        warnings,
                        isValid: errors.length === 0,
                        hasWarnings: warnings.length > 0
                    };
                },
                emailHealthAnalysis() {
                    if (!this.response.dns_records) return null;

                    // Check for MX records
                    const mxRecords = this.response.dns_records.filter(r => r.type === 'MX');
                    if (mxRecords.length === 0) return null; // Don't show section if no mail servers

                    const result = {
                        hasMx: true,
                        mxCount: mxRecords.length,
                        spf: { present: false, valid: false, strict: false, score: 0, details: [] },
                        dkim: { present: false, selectors: [], score: 0, details: [] },
                        dmarc: { present: false, valid: false, policy: null, score: 0, details: [] },
                        totalScore: 0,
                        maxScore: 100,
                        grade: 'F',
                        recommendations: []
                    };

                    // MX Score: 10 points for having MX records
                    result.totalScore += 10;

                    // SPF Analysis: 25 points total
                    // Exists: 10, Valid: 10, Strict (-all/~all): 5
                    const spfRecord = this.response.dns_records.find(r => {
                        if (r.type !== 'TXT') return false;
                        const val = r.value.replace(/^["']|["']$/g, '').trim();
                        return val.toLowerCase().startsWith('v=spf1');
                    });

                    if (spfRecord) {
                        result.spf.present = true;
                        result.spf.score += 10;
                        result.spf.details.push('SPF record found');

                        // Check validity via spfAnalysis
                        if (this.spfAnalysis && this.spfAnalysis.isValid) {
                            result.spf.valid = true;
                            result.spf.score += 10;
                            result.spf.details.push('Valid');
                        }

                        // Check strictness (-all or ~all)
                        const spfValue = spfRecord.value.replace(/^["']|["']$/g, '').trim();
                        if (spfValue.includes('-all')) {
                            result.spf.strict = true;
                            result.spf.score += 5;
                            result.spf.details.push('Hard fail');
                        } else if (spfValue.includes('~all')) {
                            result.spf.strict = true;
                            result.spf.score += 5;
                            result.spf.details.push('Soft fail');
                        } else {
                            result.recommendations.push('Upgrade SPF policy to use -all or ~all for stricter enforcement');
                        }
                    } else {
                        result.recommendations.push('Add an SPF record to authorize email senders');
                    }
                    result.totalScore += result.spf.score;

                    // DKIM Analysis: 30 points total
                    // First selector: 15, Additional: +5 each (max 30)
                    const dkimRecords = this.response.dns_records.filter(r => {
                        if (r.type !== 'TXT') return false;
                        // DKIM records have _domainkey in the name
                        return r.name.includes('._domainkey');
                    });

                    if (dkimRecords.length > 0) {
                        result.dkim.present = true;
                        // Extract selector names
                        result.dkim.selectors = dkimRecords.map(r => {
                            const match = r.name.match(/^([^.]+)\._domainkey/);
                            return match ? match[1] : r.name.split('._domainkey')[0];
                        });

                        // Score: 15 for first, +5 for each additional (max 30)
                        result.dkim.score = Math.min(30, 15 + (dkimRecords.length - 1) * 5);
                        result.dkim.details.push(`${dkimRecords.length} selector(s) found`);
                    } else {
                        result.recommendations.push('Add DKIM records to cryptographically sign outgoing emails');
                    }
                    result.totalScore += result.dkim.score;

                    // DMARC Analysis: 35 points total
                    // Exists: 10, Valid: 5, Policy: reject=20, quarantine=15, none=5
                    const dmarcRecord = this.response.dns_records.find(r => {
                        if (r.type !== 'TXT') return false;
                        return r.name.startsWith('_dmarc') && r.value.toLowerCase().includes('v=dmarc1');
                    });

                    if (dmarcRecord) {
                        result.dmarc.present = true;
                        result.dmarc.score += 10;
                        result.dmarc.details.push('DMARC found');

                        const dmarcValue = dmarcRecord.value.toLowerCase();

                        // Check for valid structure (has v=dmarc1 and p=)
                        if (dmarcValue.includes('v=dmarc1') && dmarcValue.includes('p=')) {
                            result.dmarc.valid = true;
                            result.dmarc.score += 5;
                        }

                        // Check policy
                        const policyMatch = dmarcValue.match(/p\s*=\s*(reject|quarantine|none)/);
                        if (policyMatch) {
                            result.dmarc.policy = policyMatch[1];
                            result.dmarc.details.push(`Policy: ${policyMatch[1]}`);

                            if (policyMatch[1] === 'reject') {
                                result.dmarc.score += 20;
                            } else if (policyMatch[1] === 'quarantine') {
                                result.dmarc.score += 15;
                                result.recommendations.push('Consider upgrading DMARC policy from quarantine to reject for maximum protection');
                            } else if (policyMatch[1] === 'none') {
                                result.dmarc.score += 5;
                                result.recommendations.push('Upgrade DMARC policy from none to quarantine or reject');
                            }
                        }
                    } else {
                        result.recommendations.push('Add a DMARC record to protect against email spoofing');
                    }
                    result.totalScore += result.dmarc.score;

                    // Calculate grade
                    if (result.totalScore >= 90) result.grade = 'A';
                    else if (result.totalScore >= 75) result.grade = 'B';
                    else if (result.totalScore >= 60) result.grade = 'C';
                    else if (result.totalScore >= 40) result.grade = 'D';
                    else result.grade = 'F';

                    return result;
                }
            },
            mounted() {
                this.loadHistory();

                const urlParams = new URLSearchParams(window.location.search);

                // Store deep-link domain for later (after bridge connects)
                const domainParam = urlParams.get('domain');
                if (domainParam) {
                    this.domain = this.normalizeDomain(domainParam);
                    this.pendingDeepLink = this.domain;
                }

                if (urlParams.has('local')) {
                    this.localMode = true;
                    this.checkBridgeCapabilities();
                }
                document.addEventListener('keydown', (e) => {
                    // 1. Existing shortcuts
                    if (e.key === 'Escape') {
                        this.showHistoryModal = false;
                        this.showVersionsModal = false;
                        this.showHelpModal = false;
                        this.showOgPreview = false;
                        this.showTwitterPreview = false;
                        this.showFaviconPreview = false;
                        this.showPluginsModal = false;
                        this.dialog.show = false;
                        this.contextMenu.show = false;
                        this.showAutocomplete = false;
                    }
                    if (e.key === '/' && e.target.tagName !== 'INPUT' && e.target.tagName !== 'TEXTAREA') {
                        e.preventDefault();
                        document.querySelector('input[type="text"]').focus();
                    }
                    if (e.key === '?' && e.target.tagName !== 'INPUT' && e.target.tagName !== 'TEXTAREA') {
                        e.preventDefault();
                        this.showHelpModal = true;
                    }
                    if (e.key === 'k' && (e.metaKey || e.ctrlKey)) {
                        e.preventDefault();
                        this.openHistory();
                    }

                    // 2. Snapshot Modal Navigation
                    if (this.showVersionsModal && this.domainVersions.length > 0) {
                        if (e.key === 'ArrowDown') {
                            e.preventDefault();
                            this.selectedIndex = (this.selectedIndex + 1) % this.domainVersions.length;
                            this.scrollToSelected();
                        }
                        else if (e.key === 'ArrowUp') {
                            e.preventDefault();
                            if (this.selectedIndex === -1) this.selectedIndex = this.domainVersions.length - 1;
                            else this.selectedIndex = (this.selectedIndex - 1 + this.domainVersions.length) % this.domainVersions.length;
                            this.scrollToSelected();
                        }
                        else if (e.key === 'Enter') {
                            e.preventDefault();
                            if (this.selectedIndex > -1) {
                                this.loadFromHistory(this.domainVersions[this.selectedIndex]);
                            }
                        }
                    }

                    // 3. History Modal Navigation
                    if (this.showHistoryModal && this.historyItems.length > 0) {
                        if (e.key === 'ArrowDown') {
                            e.preventDefault();
                            this.selectedHistoryIndex = (this.selectedHistoryIndex + 1) % this.historyItems.length;
                            this.scrollToSelectedHistory();
                        }
                        else if (e.key === 'ArrowUp') {
                            e.preventDefault();
                            if (this.selectedHistoryIndex === -1) this.selectedHistoryIndex = this.historyItems.length - 1;
                            else this.selectedHistoryIndex = (this.selectedHistoryIndex - 1 + this.historyItems.length) % this.historyItems.length;
                            this.scrollToSelectedHistory();
                        }
                        else if (e.key === 'Enter') {
                            e.preventDefault();
                            if (this.selectedHistoryIndex > -1) {
                                this.loadFromHistory(this.historyItems[this.selectedHistoryIndex]);
                            }
                        }
                    }
                });
            },
            methods: {
                getUrl(params) {
                    return (this.localMode ? 'http://127.0.0.1:8989/' : '') + '?' + params;
                },
                getHostFromUrl(url) {
                    try { return new URL(url).hostname; } catch { return url; }
                },
                resetView() { this.response = { domain: "", errors: [], zone: "", timestamp: null, ip_lookup: {} }; this.domain = ""; this.domainVersions = []; },
                toggleTheme() {
                    this.currentTheme = this.currentTheme === 'light' ? 'dark' : 'light';
                    localStorage.setItem('theme', this.currentTheme);
                    if (this.currentTheme === 'dark') document.documentElement.classList.add('dark');
                    else document.documentElement.classList.remove('dark');
                },
                copyZone() { navigator.clipboard.writeText(this.response.zone); this.showToast("Zone file copied!"); },
                downloadZone() {
                    const blob = new Blob([this.response.zone], { type: "text/dns" })
                    const url = window.URL.createObjectURL(blob);
                    const a = document.createElement('a'); a.href = url; a.download = `${this.domain}.txt`; a.click();
                    window.URL.revokeObjectURL(url);
                },
                copyInstallCmd() { navigator.clipboard.writeText("curl -sL https://periscope.run/boot.sh | bash"); this.showToast("Command copied!"); },
                showToast(msg) { this.snackbar.message = msg; this.snackbar.show = true; setTimeout(() => this.snackbar.show = false, 3000); },
                formatBytes(bytes) {
                    if (bytes === 0) return '0 B';
                    const k = 1024;
                    const sizes = ['B', 'KB', 'MB', 'GB'];
                    const i = Math.floor(Math.log(bytes) / Math.log(k));
                    return parseFloat((bytes / Math.pow(k, i)).toFixed(1)) + ' ' + sizes[i];
                },
                getPluginName(slug) {
                    const knownPlugins = {
                        'gravityforms': 'Gravity Forms',
                        'advanced-custom-fields': 'Advanced Custom Fields',
                        'advanced-custom-fields-pro': 'Advanced Custom Fields Pro',
                        'akismet': 'Akismet Anti-Spam',
                        'all-in-one-seo-pack': 'All in One SEO',
                        'all-in-one-wp-migration': 'All-in-One WP Migration',
                        'autoptimize': 'Autoptimize',
                        'bbpress': 'bbPress',
                        'beaver-builder-lite-version': 'Beaver Builder',
                        'better-wp-security': 'iThemes Security',
                        'broken-link-checker': 'Broken Link Checker',
                        'buddypress': 'BuddyPress',
                        'classic-editor': 'Classic Editor',
                        'contact-form-7': 'Contact Form 7',
                        'cookie-law-info': 'GDPR Cookie Consent',
                        'custom-post-type-ui': 'Custom Post Type UI',
                        'disable-comments': 'Disable Comments',
                        'duplicate-post': 'Yoast Duplicate Post',
                        'duplicator': 'Duplicator',
                        'easy-digital-downloads': 'Easy Digital Downloads',
                        'elementor': 'Elementor',
                        'elementor-pro': 'Elementor Pro',
                        'envira-gallery-lite': 'Envira Gallery',
                        'essential-addons-for-elementor-lite': 'Essential Addons for Elementor',
                        'ewww-image-optimizer': 'EWWW Image Optimizer',
                        'favicon-by-realfavicongenerator': 'Favicon by RealFaviconGenerator',
                        'flamingo': 'Flamingo',
                        'google-analytics-for-wordpress': 'MonsterInsights',
                        'google-sitemap-generator': 'Google XML Sitemaps',
                        'gtranslate': 'GTranslate',
                        'header-footer-elementor': 'Elementor Header & Footer Builder',
                        'hello-dolly': 'Hello Dolly',
                        'instagram-feed': 'Smash Balloon Instagram Feed',
                        'jetpack': 'Jetpack',
                        'limit-login-attempts-reloaded': 'Limit Login Attempts Reloaded',
                        'litespeed-cache': 'LiteSpeed Cache',
                        'mailchimp-for-wp': 'MC4WP: Mailchimp for WordPress',
                        'mailpoet': 'MailPoet',
                        'megamenu': 'Max Mega Menu',
                        'members': 'Members',
                        'ninja-forms': 'Ninja Forms',
                        'optinmonster': 'OptinMonster',
                        'really-simple-ssl': 'Really Simple SSL',
                        'redirection': 'Redirection',
                        'regenerate-thumbnails': 'Regenerate Thumbnails',
                        'restrict-content': 'Restrict Content',
                        'revslider': 'Slider Revolution',
                        'safe-svg': 'Safe SVG',
                        'sg-cachepress': 'SiteGround Optimizer',
                        'shortpixel-image-optimiser': 'ShortPixel Image Optimizer',
                        'simple-custom-css': 'Simple Custom CSS',
                        'siteguard': 'SiteGuard WP Plugin',
                        'slideshow-gallery': 'Slideshow Gallery',
                        'smart-slider-3': 'Smart Slider 3',
                        'smtp-mailer': 'SMTP Mailer',
                        'so-widgets-bundle': 'SiteOrigin Widgets Bundle',
                        'tablepress': 'TablePress',
                        'the-events-calendar': 'The Events Calendar',
                        'tinymce-advanced': 'Advanced Editor Tools',
                        'translatepress-multilingual': 'TranslatePress',
                        'updraftplus': 'UpdraftPlus',
                        'user-role-editor': 'User Role Editor',
                        'w3-total-cache': 'W3 Total Cache',
                        'webp-converter-for-media': 'WebP Converter for Media',
                        'widget-importer-exporter': 'Widget Importer & Exporter',
                        'woocommerce': 'WooCommerce',
                        'woocommerce-gateway-stripe': 'WooCommerce Stripe Gateway',
                        'woocommerce-payments': 'WooPayments',
                        'woocommerce-pdf-invoices-packing-slips': 'PDF Invoices & Packing Slips for WooCommerce',
                        'woolentor-addons': 'ShopLentor',
                        'wordpress-importer': 'WordPress Importer',
                        'wordpress-seo': 'Yoast SEO',
                        'wordfence': 'Wordfence Security',
                        'wpforms-lite': 'WPForms Lite',
                        'wpforms': 'WPForms',
                        'wp-fastest-cache': 'WP Fastest Cache',
                        'wp-mail-smtp': 'WP Mail SMTP',
                        'wp-migrate-db': 'WP Migrate DB',
                        'wp-optimize': 'WP-Optimize',
                        'wp-pagenavi': 'WP-PageNavi',
                        'wp-reset': 'WP Reset',
                        'wp-rocket': 'WP Rocket',
                        'wp-smushit': 'Smush',
                        'wp-statistics': 'WP Statistics',
                        'wp-super-cache': 'WP Super Cache',
                        'yith-woocommerce-wishlist': 'YITH WooCommerce Wishlist',
                    };
                    return knownPlugins[slug.toLowerCase()] || null;
                },
                scrollToSelected() {
                    this.$nextTick(() => {
                        const el = document.getElementById('version-item-' + this.selectedIndex);
                        if (el) el.scrollIntoView({ block: 'nearest' });
                    });
                },
                scrollToSelectedHistory() {
                    this.$nextTick(() => {
                        const el = document.getElementById('history-item-' + this.selectedHistoryIndex);
                        if (el) el.scrollIntoView({ block: 'nearest' });
                    });
                },

                // Core
                handleBlur() { setTimeout(() => { this.showAutocomplete = false; }, 200); },
                selectAutocomplete(item) { this.loadFromHistory(item); this.showAutocomplete = false; },
                normalizeDomain(input) {
                    if (!input) return '';
                    // Strip protocol
                    let domain = input.replace(/^https?:\/\//i, '');
                    // Strip path, query string, fragment
                    domain = domain.replace(/[/?#].*$/, '');
                    // Strip trailing dots and whitespace
                    domain = domain.replace(/\.+$/, '').trim();
                    // Lowercase
                    return domain.toLowerCase();
                },
                lookupDomain() {
                    if (!this.domain) return;
                    // Normalize input and update the field
                    this.domain = this.normalizeDomain(this.domain);
                    if (!this.domain) return;
                    this.loading = true;
                    this.loadingText = "Scanning...";
                    this.showAutocomplete = false;
                    this.progress = { step: 0, total: 7, percent: 0, message: 'Initializing...' };
                    this.response = { domain: "", errors: [], zone: "", timestamp: null, ip_lookup: {} };

                    // 1. Update URL
                    const newUrl = new URL(window.location);
                    newUrl.searchParams.set('domain', this.domain);
                    window.history.pushState({}, '', newUrl);

                    // Use EventSource for SSE progress updates
                    const sseUrl = this.getUrl(`scan=${encodeURIComponent(this.domain)}`);

                    // Check if EventSource is supported
                    if (typeof EventSource !== 'undefined') {
                        const eventSource = new EventSource(sseUrl);

                        eventSource.onmessage = (event) => {
                            try {
                                const payload = JSON.parse(event.data);

                                if (payload.type === 'progress') {
                                    this.progress = {
                                        step: payload.step,
                                        total: payload.total,
                                        percent: payload.percent,
                                        message: payload.message
                                    };
                                } else if (payload.type === 'complete') {
                                    eventSource.close();
                                    this.loading = false;
                                    this.progress = { step: 0, total: 7, percent: 0, message: '' };

                                    const data = payload.data;
                                    if (data.errors && data.errors.length > 0) {
                                        this.response.errors = data.errors;
                                    } else {
                                        this.response = data;
                                        this.loadHistory();
                                        this.getDomainVersions(this.domain);
                                        this.$nextTick(() => { Prism.highlightAll() });
                                    }
                                } else if (payload.type === 'error') {
                                    eventSource.close();
                                    this.loading = false;
                                    this.progress = { step: 0, total: 7, percent: 0, message: '' };
                                    this.response.errors.push(`<strong>Scan Error:</strong><br/>${payload.message}`);
                                }
                            } catch (e) {
                                // JSON parse failed
                                eventSource.close();
                                this.loading = false;
                                this.progress = { step: 0, total: 7, percent: 0, message: '' };
                                this.response.errors.push(`<strong>Server Error:</strong><br/>${event.data}`);
                            }
                        };

                        eventSource.onerror = (e) => {
                            eventSource.close();
                            this.loading = false;
                            this.progress = { step: 0, total: 7, percent: 0, message: '' };
                            const url = this.localMode ? 'http://127.0.0.1:8989' : window.location.origin;
                            this.response.errors.push(`<strong>Network Connection Failed</strong><br/><span class="text-red-600/70 dark:text-red-300/70">Could not connect to ${url}</span><br/><button onclick="document.querySelector('#app').__vue_app__._instance.proxy.lookupDomain()" class="mt-2 text-sm font-medium text-cyan-600 dark:text-cyan-400 hover:underline">Retry Connection</button>`);
                        };
                    } else {
                        // Fallback to regular fetch for older browsers
                        fetch(this.getUrl(`domain=${encodeURIComponent(this.domain)}`))
                            .then(async response => {
                                const text = await response.text();
                                try {
                                    const data = JSON.parse(text);
                                    this.loading = false;
                                    this.progress = { step: 0, total: 7, percent: 0, message: '' };

                                    if (data.errors && data.errors.length > 0) {
                                        this.response.errors = data.errors;
                                    } else {
                                        this.response = data;
                                        this.saveToHistory(this.domain, data);
                                        this.getDomainVersions(this.domain);
                                        this.$nextTick(() => { Prism.highlightAll() });
                                    }
                                } catch (e) {
                                    this.loading = false;
                                    this.progress = { step: 0, total: 7, percent: 0, message: '' };
                                    this.response.errors.push(`<strong>Server Error:</strong><br/>${text}`);
                                }
                            })
                            .catch(e => {
                                this.loading = false;
                                this.progress = { step: 0, total: 7, percent: 0, message: '' };
                                const url = this.localMode ? 'http://127.0.0.1:8989' : window.location.origin;
                                this.response.errors.push(`<strong>Network Connection Failed</strong><br/><span class="text-red-600/70 dark:text-red-300/70">Could not connect to ${url}</span><br/><button onclick="document.querySelector('#app').__vue_app__._instance.proxy.lookupDomain()" class="mt-2 text-sm font-medium text-cyan-600 dark:text-cyan-400 hover:underline">Retry Connection</button>`);
                            });
                    }
                },

                // Backend Features (Dig/Whois/Raw)
                showContextMenu(event, value) {
                    event.preventDefault();
                    this.contextMenu.value = (typeof value === 'string' ? value.trim() : '').split('\n')[0].trim();
                    this.contextMenu.x = event.clientX; this.contextMenu.y = event.clientY;
                    this.contextMenu.show = true;
                },
                copyToClipboard(text) { navigator.clipboard.writeText(text); this.contextMenu.show = false; this.showToast("Copied to clipboard"); },
                isDomain(str) { return /^[a-zA-Z0-9.-]+\.[a-zA-Z]{2,}\.?$/.test(str) && !this.isIp(str); },
                isIp(str) { return /^(?:(?:25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)\.){3}(?:25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)$/.test(str); },
                runDig(domain) {
                    this.dialog.title = `Dig: ${domain}`; this.dialog.content = 'Loading...'; this.dialog.tabs = null; this.dialog.activeTab = null; this.dialog.show = true; this.contextMenu.show = false;
                    fetch(this.getUrl(`dig=${encodeURIComponent(domain)}`)).then(r => r.text()).then(d => this.dialog.content = d || 'No results.');
                },
                viewWhois(ip) {
                    this.dialog.title = `Whois: ${ip}`; this.dialog.content = 'Loading...'; this.dialog.tabs = null; this.dialog.activeTab = null; this.dialog.show = true; this.contextMenu.show = false;
                    // Fetch stored WHOIS from scan data
                    const baseUrl = `action=get_raw&domain=${encodeURIComponent(this.domain)}&timestamp=${this.response.timestamp}&type=whois_ip_${ip}`;
                    fetch(this.getUrl(baseUrl)).then(r => r.text()).then(d => {
                        this.dialog.content = (d && !d.includes('No raw data')) ? d : 'No WHOIS data stored for this IP.';
                    });
                },
                showRawWhois() {
                    const displayDomain = this.response.is_subdomain ? this.response.root_domain : this.domain;
                    this.dialog.title = `Raw Data: ${displayDomain}`;
                    this.dialog.content = 'Loading...';
                    this.dialog.tabs = null;
                    this.dialog.activeTab = null;
                    this.dialog.show = true;

                    const baseUrl = `action=get_raw&domain=${encodeURIComponent(this.domain)}&timestamp=${this.response.timestamp}`;
                    Promise.all([
                        fetch(this.getUrl(`${baseUrl}&type=whois_domain`)).then(r => r.text()),
                        fetch(this.getUrl(`${baseUrl}&type=rdap`)).then(r => r.text())
                    ]).then(([whois, rdap]) => {
                        const tabs = {};
                        if (whois && !whois.includes('No raw data')) tabs['WHOIS'] = whois;
                        if (rdap && !rdap.includes('No raw data')) {
                            try {
                                tabs['RDAP'] = JSON.stringify(JSON.parse(rdap), null, 2);
                            } catch (e) {
                                tabs['RDAP'] = rdap;
                            }
                        }
                        if (Object.keys(tabs).length > 0) {
                            this.dialog.tabs = tabs;
                            this.dialog.activeTab = Object.keys(tabs)[0];
                            this.dialog.content = '';
                        } else {
                            this.dialog.content = 'No raw data stored for this scan.';
                        }
                    });
                },
                showRawPreview(type, title) {
                    this.dialog.title = title;
                    this.dialog.content = 'Loading...';
                    this.dialog.tabs = null;
                    this.dialog.activeTab = null;
                    this.dialog.show = true;
                    
                    const url = `action=get_raw&domain=${encodeURIComponent(this.domain)}&timestamp=${this.response.timestamp}&type=${type}`;
                    fetch(this.getUrl(url)).then(r => r.text()).then(content => {
                        if (content && !content.includes('No raw data')) {
                            this.dialog.content = content;
                        } else {
                            this.dialog.content = 'No data stored for this scan. Re-scan to capture this file.';
                        }
                    });
                },

                // History
                openHistory() {
                    this.loadHistory();
                    this.showHistoryModal = true;
                },
                checkBridgeCapabilities() {
                    fetch(this.getUrl('action=check_status'))
                        .then(r => r.json())
                        .then(data => {
                            this.bridgeConnected = true;
                            this.bridgeHasDb = data.has_db;
                            this.serverVersion = data.plugin_version || null;
                            if (data.has_db) {
                                this.dbInfo = {
                                    path: data.db_path || '',
                                    size: data.db_size || 0,
                                    scanCount: data.scan_count || 0
                                };
                            }
                            // Scans directory info
                            this.scansInfo = {
                                path: data.scans_path || '',
                                size: data.scans_size || 0
                            };

                            // Wait for history to load before processing deep link
                            this.loadHistory().then(() => {
                                if (this.pendingDeepLink) {
                                    this.handleDeepLink(this.pendingDeepLink);
                                    this.pendingDeepLink = null;
                                }
                            });
                        })
                        .catch(e => {
                            this.bridgeConnected = false;
                            this.pendingDeepLink = null;
                        });
                },
                handleDeepLink(domain) {
                    const cached = this.historyItems.find(item =>
                        item.domain.toLowerCase() === domain.toLowerCase()
                    );

                    if (cached) {
                        this.loadFromHistory(cached);
                    } else {
                        this.domain = domain;
                        this.lookupDomain();
                    }
                },
                loadHistory(append = false) {
                    if (this.bridgeHasDb) {
                        const offset = append ? this.historyItems.length : 0;
                        let params = `action=get_history&offset=${offset}`;
                        if (this.historySearch) params += `&search=${encodeURIComponent(this.historySearch)}`;
                        if (this.historyFilters.existence !== 'all') params += `&existence=${this.historyFilters.existence}`;
                        if (this.historyFilters.platform !== 'all') params += `&platform=${encodeURIComponent(this.historyFilters.platform)}`;
                        if (this.historyFilters.scanCount !== 'all') params += `&scan_count=${encodeURIComponent(this.historyFilters.scanCount)}`;
                        return fetch(this.getUrl(params))
                            .then(r => r.json())
                            .then(data => {
                                if (append) {
                                    this.historyItems = [...this.historyItems, ...data.items];
                                } else {
                                    this.historyItems = data.items;
                                }
                                this.historyTotal = data.total;
                            });
                    } else {
                        const stored = localStorage.getItem('periscope_history');
                        if (stored) {
                            let items = JSON.parse(stored);
                            if (this.historySearch) {
                                items = items.filter(i => i.domain.toLowerCase().includes(this.historySearch.toLowerCase()));
                            }
                            // Apply existence filter
                            if (this.historyFilters.existence === 'exists') {
                                items = items.filter(i => i.data && i.data.domain_exists !== false);
                            } else if (this.historyFilters.existence === 'nonexistent') {
                                items = items.filter(i => i.data && i.data.domain_exists === false);
                            }
                            // Apply platform filter
                            if (this.historyFilters.platform !== 'all') {
                                items = items.filter(i => i.data && i.data.cms && i.data.cms.name === this.historyFilters.platform);
                            }
                            // Apply scan count filter (group by domain first)
                            if (this.historyFilters.scanCount !== 'all') {
                                const domainCounts = {};
                                items.forEach(i => { domainCounts[i.domain] = (domainCounts[i.domain] || 0) + 1; });
                                const filterValue = this.historyFilters.scanCount;
                                items = items.filter(i => {
                                    const count = domainCounts[i.domain];
                                    return this.matchesScanCountFilter(count, filterValue);
                                });
                            }
                            this.historyItems = items;
                            this.historyTotal = items.length;
                        }
                        return Promise.resolve();
                    }
                },
                loadAvailablePlatforms() {
                    if (this.bridgeHasDb) {
                        fetch(this.getUrl('action=get_platforms'))
                            .then(r => r.json())
                            .then(data => { this.availablePlatforms = data; });
                    } else {
                        const stored = localStorage.getItem('periscope_history');
                        if (stored) {
                            const items = JSON.parse(stored);
                            const platforms = new Set();
                            items.forEach(i => {
                                if (i.data && i.data.cms && i.data.cms.name) {
                                    platforms.add(i.data.cms.name);
                                }
                            });
                            this.availablePlatforms = [...platforms].sort();
                        }
                    }
                },
                loadScanCountOptions() {
                    if (this.bridgeHasDb) {
                        fetch(this.getUrl('action=get_scan_counts'))
                            .then(r => r.json())
                            .then(data => { this.scanCountOptions = data; });
                    } else {
                        const stored = localStorage.getItem('periscope_history');
                        if (stored) {
                            const items = JSON.parse(stored);
                            const domainCounts = {};
                            items.forEach(i => { domainCounts[i.domain] = (domainCounts[i.domain] || 0) + 1; });
                            this.scanCountOptions = this.buildScanCountOptions(Object.values(domainCounts));
                        }
                    }
                },
                buildScanCountOptions(counts) {
                    if (!counts.length) return [];
                    const distribution = {};
                    counts.forEach(c => { distribution[c] = (distribution[c] || 0) + 1; });
                    const uniqueCounts = Object.keys(distribution).map(Number).sort((a, b) => a - b);
                    const options = [];
                    
                    // If only a few unique counts, show each individually
                    if (uniqueCounts.length <= 5) {
                        uniqueCounts.forEach(count => {
                            const domains = distribution[count];
                            options.push({
                                value: String(count),
                                label: `${count} scan${count > 1 ? 's' : ''} (${domains} domain${domains > 1 ? 's' : ''})`
                            });
                        });
                    } else {
                        // Build smart ranges based on distribution
                        const max = Math.max(...uniqueCounts);
                        const ranges = [];
                        
                        // Always include "1 scan" if it exists
                        if (distribution[1]) {
                            ranges.push({ min: 1, max: 1, label: '1 scan' });
                        }
                        
                        // Group remaining into ranges
                        if (max >= 2) {
                            const mid = Math.min(5, Math.floor(max / 2));
                            if (mid > 1) {
                                ranges.push({ min: 2, max: mid, label: `2-${mid} scans` });
                            }
                            if (max > mid) {
                                ranges.push({ min: mid + 1, max: max, label: `${mid + 1}+ scans` });
                            }
                        }
                        
                        ranges.forEach(range => {
                            let domainCount = 0;
                            for (let i = range.min; i <= (range.max === max ? max : range.max); i++) {
                                domainCount += distribution[i] || 0;
                            }
                            if (domainCount > 0) {
                                options.push({
                                    value: range.min === range.max ? String(range.min) : `${range.min}-${range.max}`,
                                    label: `${range.label} (${domainCount} domain${domainCount > 1 ? 's' : ''})`
                                });
                            }
                        });
                    }
                    return options;
                },
                matchesScanCountFilter(count, filterValue) {
                    // Handle exact match (e.g., "1", "2", "3")
                    if (/^\d+$/.test(filterValue)) {
                        return count === parseInt(filterValue);
                    }
                    // Handle range (e.g., "2-5")
                    const rangeMatch = filterValue.match(/^(\d+)-(\d+)$/);
                    if (rangeMatch) {
                        const min = parseInt(rangeMatch[1]);
                        const max = parseInt(rangeMatch[2]);
                        return count >= min && count <= max;
                    }
                    // Handle open-ended range (e.g., "6+")
                    const plusMatch = filterValue.match(/^(\d+)\+$/);
                    if (plusMatch) {
                        return count >= parseInt(plusMatch[1]);
                    }
                    return true;
                },
                applyHistoryFilters() {
                    this.selectedHistoryIndex = -1;
                    this.loadHistory(false);
                },
                clearHistoryFilters() {
                    this.historyFilters = { existence: 'all', platform: 'all', scanCount: 'all' };
                    this.loadHistory(false);
                },
                searchHistory() {
                    this.selectedHistoryIndex = -1;
                    clearTimeout(this.searchTimeout);
                    this.searchTimeout = setTimeout(() => this.loadHistory(false), 300);
                },
                loadMoreHistory() {
                    this.loadHistory(true);
                },
                getDomainVersions(domain) {
                    if (this.bridgeHasDb) fetch(this.getUrl(`action=get_domain_versions&domain=${encodeURIComponent(domain)}`)).then(r => r.json()).then(data => { this.domainVersions = data; });
                    else if (this.historyItems) this.domainVersions = this.historyItems.filter(item => item.domain.toLowerCase() === domain.toLowerCase());
                },
                saveToHistory(domain, data) {
                    if (this.bridgeHasDb) fetch(this.getUrl('action=save_history'), { method: 'POST', body: JSON.stringify({ domain, data }) }).then(() => { this.loadHistory(); this.getDomainVersions(domain); });
                    else {
                        if (!data.timestamp) data.timestamp = Math.floor(Date.now() / 1000);
                        this.historyItems.unshift({ domain, timestamp: data.timestamp, data });
                        if (this.historyItems.length > 50) this.historyItems.pop();
                        localStorage.setItem('periscope_history', JSON.stringify(this.historyItems));
                        this.getDomainVersions(domain);
                    }
                },
                loadFromHistory(item) {
                    this.domain = item.domain;
                    this.showHistoryModal = false;
                    this.showVersionsModal = false;
                    if (item.data) { this.finishLoad(item, item.data); return; }
                    if (this.bridgeHasDb && item.id) {
                        this.loading = true;
                        this.loadingText = "Loading...";
                        this.loadingFromHistory = true;
                        // Clear current response while loading
                        this.response = { domain: "", errors: [], zone: "", timestamp: null, ip_lookup: {} };
                        fetch(this.getUrl(`action=get_history_item&id=${item.id}`)).then(r => r.json()).then(data => { 
                            this.loading = false;
                            this.loadingFromHistory = false;
                            this.finishLoad(item, data); 
                            
                            // Check if cache was regenerated or needs regeneration
                            if (data.cache_status === 'regenerated') {
                                this.showToast('Cache updated for new plugin version');
                            } else if (this.serverVersion && data.plugin_version && data.plugin_version !== this.serverVersion) {
                                // Version mismatch - trigger background regeneration
                                this.regenerateCache(item.id);
                            }
                        });
                    }
                },
                regenerateCache(id) {
                    // Background regeneration - updates cache and refreshes UI if data changed
                    fetch(this.getUrl(`action=regenerate_cache&id=${id}`))
                        .then(r => r.json())
                        .then(result => {
                            if (result.success && result.data) {
                                // Check if anything meaningful changed
                                const oldJson = JSON.stringify(this.response);
                                const newJson = JSON.stringify(result.data);
                                if (oldJson !== newJson) {
                                    this.response = result.data;
                                    this.$nextTick(() => { Prism.highlightAll() });
                                    this.showToast('Scan data updated');
                                }
                            }
                        })
                        .catch(() => { /* Silent fail for background regeneration */ });
                },
                finishLoad(item, data) {
                    this.response = data; if (!this.response.timestamp) this.response.timestamp = item.timestamp;
                    this.getDomainVersions(item.domain); this.$nextTick(() => { Prism.highlightAll() });

                    // Update URL to reflect selected domain
                    const newUrl = new URL(window.location);
                    newUrl.searchParams.set('domain', item.domain);
                    window.history.pushState({}, '', newUrl);
                },
                deleteHistoryItem(index, item) {
                    if (this.bridgeHasDb) {
                        const fd = new FormData();
                        fd.append('id', item.id);
                        fetch(this.getUrl('action=delete_history'), { method: 'POST', body: fd })
                            .then(() => {
                                this.loadHistory();
                                // Only refresh versions if we are currently looking at this domain
                                if (this.domain === item.domain) this.getDomainVersions(this.domain);
                                this.showToast('Scan deleted');
                            });
                    } else {
                        this.historyItems.splice(index, 1);
                        localStorage.setItem('periscope_history', JSON.stringify(this.historyItems));
                        if (this.domain === item.domain) this.getDomainVersions(this.domain);
                        this.showToast('Scan deleted');
                    }
                },
                exportHistory() { window.location.href = this.getUrl('action=export_history'); },
                triggerImport() { this.$refs.importFile.click(); },
                importHistory(e) {
                    const file = e.target.files[0]; if (!file) return;
                    const fd = new FormData(); fd.append('importFile', file);
                    fetch(this.getUrl('action=import_history'), { method: 'POST', body: fd })
                        .then(r => r.json())
                        .then(d => { if (d.success) { this.showToast(`Imported ${d.count} items`); this.loadHistory(); } else this.showToast('Import failed'); })
                        .finally(() => e.target.value = '');
                }
            }
        }).mount('#app');
    </script>
</body>

</html>